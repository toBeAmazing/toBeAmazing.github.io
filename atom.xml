<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>JollyFly&#39;s Blog</title>
  <subtitle>勿在浮沙筑高台</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://jollyfly.com/"/>
  <updated>2017-09-21T01:59:57.833Z</updated>
  <id>http://jollyfly.com/</id>
  
  <author>
    <name>JollyFly</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>加油</title>
    <link href="http://jollyfly.com/2017/09/21/essay1/"/>
    <id>http://jollyfly.com/2017/09/21/essay1/</id>
    <published>2017-09-21T01:40:48.000Z</published>
    <updated>2017-09-21T01:59:57.833Z</updated>
    
    <content type="html"><![CDATA[<p>到现在，工作也有一年多了，一年多确实也成长了不少。<br>毕业时，从只会框架的使用，到后来工作慢慢接触到各种中间件、也包括对开源社区的了解。基本上每天都会花一两个小时去看看博客啊、码云上的新项目等内容，自己也会做一些尝试。可能自己多多少少还是有些浮躁的，对于基础还需要巩固。<br>加油吧！</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;到现在，工作也有一年多了，一年多确实也成长了不少。&lt;br&gt;毕业时，从只会框架的使用，到后来工作慢慢接触到各种中间件、也包括对开源社区的了解。基本上每天都会花一两个小时去看看博客啊、码云上的新项目等内容，自己也会做一些尝试。可能自己多多少少还是有些浮躁的，对于基础还需要巩固。
    
    </summary>
    
      <category term="日记" scheme="http://jollyfly.com/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
      <category term="随笔" scheme="http://jollyfly.com/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>Spring session入门（一）</title>
    <link href="http://jollyfly.com/2017/09/16/Spring-Session/"/>
    <id>http://jollyfly.com/2017/09/16/Spring-Session/</id>
    <published>2017-09-16T01:38:51.000Z</published>
    <updated>2017-09-16T03:33:46.280Z</updated>
    
    <content type="html"><![CDATA[<p>Session与Cookie是web开发中非常重要的两个概念。在研究Spring session前，有必要再复习一下session和cookie的基础知识。</p>
<h1 id="Session与Cookie"><a href="#Session与Cookie" class="headerlink" title="Session与Cookie"></a>Session与Cookie</h1><p>要说Session与Cookie就要从Http协议说起了。Http协议是一个无状态的协议，一次请求对应一次响应。对于不同的客户端的多次对服务器的请求，需要引入一个机制来判断这些请求是否是同一个用户所为，于是就有了Session和Cookie的机制。在单体式应用中，Session存在于servlet容器的内存中，由容器进行管理。而Cookie则是存在于客户端中，服务器在处理完请求后返回的Response可以携带Cookie并保存在客户端中。</p>
<h2 id="sessionId"><a href="#sessionId" class="headerlink" title="sessionId"></a>sessionId</h2><p>sessionId是存放在客户端的一个Cookie，真正建立起了客户端与服务端的桥梁。用户发起请求，当服务端往Session中保存一些数据时，Response中自动添加一个Cookie：JSESSIONID，在后面的请求中会自动携带这个Cookie，服务端根据Cookie中的JSESSIONID找到对应的Session，以取得用户之前访问所存储的数据。</p>
<h1 id="Spring-Session"><a href="#Spring-Session" class="headerlink" title="Spring Session"></a>Spring Session</h1><p>Cookie和Session的机制并不能很好的支持分布式的应用，在分布式应用中通常需要Session共享，Servlet容器一般可以通过配置Session共享来解决这个问题。但是使用Session和Cookie也会带来一定的安全问题。基于上面的介绍，如果JSESSIONID被修改通常会导致会话时效的问题，甚至于将JSESSIONID修改为别人的更会导致信息的泄露与盗取。<br>Spring Session的官网介绍如下：</p>
<blockquote>
<p>Spring Session provides an API and implementations for managing a user’s session information. It also provides transparent integration with:</p>
<ul>
<li><p>HttpSession - allows replacing the HttpSession in an application container (i.e. Tomcat) neutral way. Additional features include:</p>
<ul>
<li><p>Clustered Sessions - Spring Session makes it trivial to support clustered sessions without being         tied to an application container specific solution.</p>
</li>
<li><p>Multiple Browser Sessions - Spring Session supports managing multiple users’ sessions in a single browser instance (i.e. multiple authenticated accounts similar to Google).</p>
</li>
<li><p>RESTful APIs - Spring Session allows providing session ids in headers to work with RESTful APIs</p>
</li>
</ul>
</li>
<li><p>WebSocket - provides the ability to keep the HttpSession alive when receiving WebSocket messages</p>
</li>
</ul>
</blockquote>
<p>大概意思是：<br>Spring Session提供了一个用于管理用户会话信息的API和实现。还包括以下额外功能：</p>
<ol>
<li>HttpSession 运行在应用程序容器，例如Tomcat中替代HttpSession，包括<ul>
<li>集群会话</li>
<li>多个浏览器会话</li>
<li>RestfulAPI</li>
</ul>
</li>
<li>WebSocket 技工HttpSession在接受WebSocket消息时保持活动的能力。</li>
</ol>
<p>Spring Session可以通过第三方的仓库来实现集群Session管理，也就是分布式Session。对此，Spirng提供了三个实现：redis、mongodb、jdbc。其中redis是最常用的一个。</p>
<p>扯了这么多下面开始进入正题，集成Spring Session</p>
<h1 id="Redis集成Spring-Session"><a href="#Redis集成Spring-Session" class="headerlink" title="Redis集成Spring Session"></a>Redis集成Spring Session</h1><p>本次集成使用Spring Boot，版本为最新的1.5.4，JDK1.8<br>首先在pom文件中引入依赖。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在配置类中开启Redis HttpSession：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableRedisHttpSession</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSessionConfig</span> </span>&#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认的redis配置为 host：localhost   port： 6379 如果没有变化，就不需要配置redis<br>下面编写Controller来测试Spring Session<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSController</span> </span>&#123;</div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/ss/cookie"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">cookie</span><span class="params">(HttpSession session, HttpServletRequest request)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (session.getAttribute(<span class="string">"test"</span>) == <span class="keyword">null</span>)&#123;</div><div class="line">            System.out.println(<span class="string">"不存在session"</span>);</div><div class="line">            session.setAttribute(<span class="string">"test"</span>,<span class="string">"test"</span>);</div><div class="line">        &#125;</div><div class="line">        Cookie[] cookies = request.getCookies();</div><div class="line">        <span class="keyword">if</span> (cookies != <span class="keyword">null</span> &amp;&amp; cookies.length &gt; <span class="number">0</span>)&#123;</div><div class="line">            <span class="comment">//如果有cookie，则打印</span></div><div class="line">            Arrays.asList(cookies).forEach(cookie -&gt; System.out.println(cookie.getName()+<span class="string">":"</span>+cookie.getValue()));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>启动应用后，在浏览器中访问<a href="http://localhost:8080/ss/cookie" target="_blank" rel="external">http://localhost:8080/ss/cookie</a><br>访问多次结果如下</p>
<ul>
<li>第一次：不存在session</li>
<li>第二次：SESSION：9dcf19ee-3b8a-4bbc-bb46-0d6354b1c1bf</li>
<li>第三次：SESSION: 9dcf19ee-3b8a-4bbc-bb46-0d6354b1c1bf</li>
</ul>
<p>原生的Session使用的是JSESSIONID，而使用SpringSession后key值变为了SESSION<br>查询redis：<br><img src="/img/springsession.jpg" alt="查询redis"><br>在redis也记录了当前的session信息。</p>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>本文对Spring Session做了一个最基本的介绍以及集成，关于Spring Session的更多特性将在后面进行介绍。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Session与Cookie是web开发中非常重要的两个概念。在研究Spring session前，有必要再复习一下session和cookie的基础知识。&lt;/p&gt;
&lt;h1 id=&quot;Session与Cookie&quot;&gt;&lt;a href=&quot;#Session与Cookie&quot; clas
    
    </summary>
    
      <category term="spring session" scheme="http://jollyfly.com/categories/spring-session/"/>
    
    
      <category term="spring" scheme="http://jollyfly.com/tags/spring/"/>
    
      <category term="spring session" scheme="http://jollyfly.com/tags/spring-session/"/>
    
  </entry>
  
  <entry>
    <title>LinkedList源码分析</title>
    <link href="http://jollyfly.com/2017/08/29/linkedlist/"/>
    <id>http://jollyfly.com/2017/08/29/linkedlist/</id>
    <published>2017-08-29T11:16:20.000Z</published>
    <updated>2017-09-12T01:32:43.957Z</updated>
    
    <content type="html"><![CDATA[<p>LinkedList是比较常用的数据结构，本次分析的源码基于jdk1.8<br>上来先来个类图镇楼<br><img src="/img/linkedlist.jpg" alt="LinkedList"><br>可以看出LinkedList不仅实现了List接口，同样实现了Queue接口。从类图可以看出，继承自AbstractSequentialList，所以LinkedList是一个<strong>有序列表</strong>，同时也实现了Deque接口，因此LinkedList是一个<strong>双端队列</strong>，所谓的双端队列，即两端的元素既能入队也能出队。由于这个特性，LinkedList也可以被当做堆栈进行操作。</p>
<h1 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h1><p>先从Node看起，Node是定义在LinkedList中的内部类，源码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    E item;</div><div class="line">    Node&lt;E&gt; next;</div><div class="line">    Node&lt;E&gt; prev;</div><div class="line"></div><div class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</div><div class="line">        <span class="keyword">this</span>.item = element;</div><div class="line">        <span class="keyword">this</span>.next = next;</div><div class="line">        <span class="keyword">this</span>.prev = prev;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，在Node中记录了当前节点存储的数据，同时也记录了其前一个节点和后一个节点的引用。<br>就像军训排队，每个人只需要记住自己的前一个和后一个是谁，队伍就能排出来</p>
<h1 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h1><p>在看构造方法前，先看LinkedList的类属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//记录LinkedList的大小</div><div class="line">transient int size = 0;</div><div class="line">//记录第一个节点</div><div class="line">transient Node&lt;E&gt; first;</div><div class="line">//记录最后一个节点</div><div class="line">transient Node&lt;E&gt; last;</div></pre></td></tr></table></figure></p>
<p>LinkedList无参构造器如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public LinkedList()&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面没有进行任何初始化的操作。也就是new出来的LinkedList，其中的第一个节点和最后一个节点都是null。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public LinkedList(Collection&lt;? extends E&gt; c) &#123;</div><div class="line">    this();</div><div class="line">    addAll(c);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第二个构造方法，要求传一个集合，关键点在于线面的addAll方法。<br>下面的addAll方法是只有一个参数的重载，第一个index参数传入的是size，也就是当前LinkedList的大小即0<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">public boolean addAll(int index, Collection&lt;? extends E&gt; c) &#123;</div><div class="line">    //传入的index为0</div><div class="line">    // 如果插入位置超过了链表的长度或小于0，抛出IndexOutOfBoundsException</div><div class="line">    checkPositionIndex(index);</div><div class="line">    Object[] a = c.toArray();</div><div class="line">    int numNew = a.length;</div><div class="line">    //集合转换过来的数组长度为零则返回false，不进行下面的操作。在构造方法中相当于只调用了无参构造器</div><div class="line">    if (numNew == 0)</div><div class="line">        return false;</div><div class="line"></div><div class="line"></div><div class="line">    //定义两个Node类型变量</div><div class="line">    Node&lt;E&gt; pred, succ;</div><div class="line">    </div><div class="line">    if (index == size) &#123;</div><div class="line">        succ = null;</div><div class="line">        pred = last;</div><div class="line">    &#125; else &#123;</div><div class="line">        succ = node(index);</div><div class="line">        pred = succ.prev;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    for (Object o : a) &#123;</div><div class="line">        @SuppressWarnings(&quot;unchecked&quot;) E e = (E) o;</div><div class="line">        Node&lt;E&gt; newNode = new Node&lt;&gt;(pred, e, null);</div><div class="line">        if (pred == null)</div><div class="line">            first = newNode;</div><div class="line">        else</div><div class="line">            pred.next = newNode;</div><div class="line">        pred = newNode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (succ == null) &#123;</div><div class="line">        last = pred;</div><div class="line">    &#125; else &#123;</div><div class="line">        pred.next = succ;</div><div class="line">        succ.prev = pred;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    size += numNew;</div><div class="line">    modCount++;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="关键方法解析"><a href="#关键方法解析" class="headerlink" title="关键方法解析"></a>关键方法解析</h1><p>在LinkedList中，比较关键的方法，LinkFirst<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">private void linkFirst(E e) &#123;</div><div class="line">    final Node&lt;E&gt; f = first;</div><div class="line">    final Node&lt;E&gt; newNode = new Node&lt;&gt;(null, e, f);</div><div class="line">    first = newNode;</div><div class="line">    if (f == null)</div><div class="line">        last = newNode;</div><div class="line">    else</div><div class="line">        f.prev = newNode;</div><div class="line">    size++;</div><div class="line">    modCount++;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当LinkedList中的元素为空。即 first = null  ， last = null  ， size = 0<br><img src="/img/LinkedList1.jpg" alt="linkFirst"><br>此时执行完毕之后，结果如上图所示，新增了一个Node，并且first和last都指向新增的节点。此时如果再执行一次linkFirst，结果如下：<br><img src="/img/LinkedList3.jpg" alt="linkFirst"></p>
<p>另外一个类似的方法是linkLast，方法逻辑一样。</p>
<p># </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;LinkedList是比较常用的数据结构，本次分析的源码基于jdk1.8&lt;br&gt;上来先来个类图镇楼&lt;br&gt;&lt;img src=&quot;/img/linkedlist.jpg&quot; alt=&quot;LinkedList&quot;&gt;&lt;br&gt;可以看出LinkedList不仅实现了List接口，同样实现了Q
    
    </summary>
    
      <category term="数据结构" scheme="http://jollyfly.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
      <category term="数据结构" scheme="http://jollyfly.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="链表" scheme="http://jollyfly.com/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>java代理模式</title>
    <link href="http://jollyfly.com/2017/08/25/proxy/"/>
    <id>http://jollyfly.com/2017/08/25/proxy/</id>
    <published>2017-08-25T01:14:36.000Z</published>
    <updated>2017-09-07T08:20:10.676Z</updated>
    
    <content type="html"><![CDATA[<p>代理模式是java中非常常见的设计模式，又有动态代理和静态代理之分。通过代理对象控制原对象的访问。以下是一个简单的代理模式的类图。图中Subject是接口，RealSubject是真是的角色，而SubjectProxy是代理角色。<br><img src="/img/proxy.jpg" alt="代理模式"><br>代理模式其实比较好理解，例如生活中房东与中介。租客需要租房子，而房东和中介都可以提供出租服务，即这二者实现了同一个接口。中介代理房东的房子来进行出租，而真正的租客所使用的一般是中介的服务。</p>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><p>直接上代码<br>接口：Rental<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rental</span></span>&#123;</div><div class="line">    <span class="comment">//出租房子</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">renting</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>房东：Owner<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Owner</span> <span class="keyword">implements</span> <span class="title">Rental</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renting</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"出租房屋"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>中介： Intermediary<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Intermediary</span> <span class="keyword">implements</span> <span class="title">Rental</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Owner owner;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Intermediary</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.owner = <span class="keyword">new</span> Owner();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renting</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.owner.renting();</div><div class="line">        System.out.println(<span class="string">"收中介费"</span>);</div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上是一个简单的静态代理的例子。代理类实在编译时就已经实现好的，在使用时，需要对每个真实的角色去实现代理，大量使用不是特别方便，灵活性也比较差。</p>
<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><h2 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h2><p>JDK动态代理主要涉及一下两个类</p>
<ol>
<li>InvocationHandler<br>该接口中定义一个方法：<br> <code>Object invoke(Object proxy,Method method,Object... args) throws Throwable</code><br>第一个参数指的是代理类，method指被代理的方法，args指该方法的参数数组</li>
<li>Proxy 改类即为动态代理类</li>
</ol>
<p>直接上代码<br>Subject:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RealSubject:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"执行。。"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SubjectProxy:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Object delegate;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubjectHandler</span><span class="params">(Object subject)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.delegate = subject;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        before();</div><div class="line">        Object obj = method.invoke(delegate, args);</div><div class="line">        after();</div><div class="line">        <span class="keyword">return</span> obj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"执行前"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"执行后"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span></span>&#123;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">       RealSubject subject = <span class="keyword">new</span> RealSubject();</div><div class="line">       Subject proxy = (Subject) Proxy.newProxyInstance(RealSubject.class.getClassLoader()</div><div class="line">               ,<span class="keyword">new</span> Class[]&#123;Subject.class&#125;,<span class="keyword">new</span> SubjectHandler(subject));</div><div class="line"></div><div class="line">       proxy.request();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用JDK的动态代理必须要定义接口。如果在实现类中新增了接口中没有定义的方法，这个方法是无法被代理的。<br>JDK动态代理所用到的代理类在程序调用到代理类对象时才由JVM真正创建，JVM根据传进来的业务实现类对象以及方法名动态地创建了一个代理类的class文件并被字节码引擎执行，然后通过该代理类对象进行方法调用。</p>
<h2 id="CGlib动态代理"><a href="#CGlib动态代理" class="headerlink" title="CGlib动态代理"></a>CGlib动态代理</h2><p>cglib动态代理的思路和jdk的有所区别。cglib通过继承实现类，从而对实现类的方法进行代理。这样被final修饰的类就无法被代理。<br>先看代码</p>
<p>Subject<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"执行中"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">实现MethodInterceptor方法大力接口，创建代理类</div><div class="line">```java</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Object target;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getTarget</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.target = target;</div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setSuperclass(<span class="keyword">this</span>.target.getClass());</div><div class="line">        enhancer.setCallback(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> enhancer.create();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span> </div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj , Method method , Object... args , MethodProxy proxy)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"执行前"</span>);</div><div class="line">        proxy.invokeSuper(obj,args);</div><div class="line">        System.out.println(<span class="string">"执行后"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;代理模式是java中非常常见的设计模式，又有动态代理和静态代理之分。通过代理对象控制原对象的访问。以下是一个简单的代理模式的类图。图中Subject是接口，RealSubject是真是的角色，而SubjectProxy是代理角色。&lt;br&gt;&lt;img src=&quot;/img/pro
    
    </summary>
    
      <category term="设计模式" scheme="http://jollyfly.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="proxy" scheme="http://jollyfly.com/tags/proxy/"/>
    
      <category term="动态代理" scheme="http://jollyfly.com/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Linux Iptables</title>
    <link href="http://jollyfly.com/2017/08/20/iptable/"/>
    <id>http://jollyfly.com/2017/08/20/iptable/</id>
    <published>2017-08-20T05:23:48.000Z</published>
    <updated>2017-09-05T08:46:41.476Z</updated>
    
    <content type="html"><![CDATA[<p>Iptables也称作netfilter，是linux系统自带的防火墙工具，功能强大，使用灵活。在此记录下常用的命令及配置，以方便以后的使用。</p>
<h1 id="Iptables服务相关命令"><a href="#Iptables服务相关命令" class="headerlink" title="Iptables服务相关命令"></a>Iptables服务相关命令</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#1.查看iptables状态</span></div><div class="line">service iptables status</div><div class="line"><span class="comment">#2. 开启/关闭 iptables</span></div><div class="line">service iptables start</div><div class="line">service iptables stop</div><div class="line"><span class="comment">#3. 查看iptables是否开机自启</span></div><div class="line">chkconfig iptables --list</div><div class="line"><span class="comment">#4. 设置iptables开机启动/不启动</span></div><div class="line">chkconfig iptables on</div><div class="line">chkconfig iptables off</div></pre></td></tr></table></figure>
<h1 id="Iptables相关命令"><a href="#Iptables相关命令" class="headerlink" title="Iptables相关命令"></a>Iptables相关命令</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看帮助</span></div><div class="line">iptables -h</div><div class="line">man iptables</div><div class="line"></div><div class="line"><span class="comment">#列出iptables规则</span></div><div class="line">iptables -L -n</div><div class="line"></div><div class="line"><span class="comment">#列出iptables规则并显示规则编号</span></div><div class="line">iptables -L -n --line-numbers</div><div class="line"></div><div class="line"><span class="comment">#列出iptables nat表规则（默认是filter表）</span></div><div class="line">iptables -L -n -t nat</div><div class="line"></div><div class="line"><span class="comment">#清除默认规则（注意默认是filter表，如果对nat表操作要加-t nat）</span></div><div class="line"><span class="comment">#清楚所有规则</span></div><div class="line">iptables -F </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#重启iptables发现规则依然存在，因为没有保存</span></div><div class="line">service iptables restart</div><div class="line"></div><div class="line"><span class="comment">#保存配置</span></div><div class="line">service iptables save</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#禁止ssh登陆（若果服务器在机房，一定要小心）</span></div><div class="line">iptables -A INPUT -p tcp --dport 22 -j DROP</div><div class="line"></div><div class="line"><span class="comment">#删除规则</span></div><div class="line">iptables -D INPUT -p tcp --dport 22 -j DROP</div><div class="line">:&lt;&lt;!</div><div class="line">-A, --append chain	追加到规则的最后一条</div><div class="line">-D, --delete chain [rulenum]	Delete rule rulenum (1 = first) from chain</div><div class="line">-I, --insert chain [rulenum]	Insert <span class="keyword">in</span> chain as rulenum (default 1=first) 添加到规则的第一条</div><div class="line">-p, --proto  proto	protocol: by number or name, eg. <span class="string">'tcp'</span>,常用协议有tcp、udp、icmp、all</div><div class="line">-j, --jump target 常见的行为有ACCEPT、DROP和REJECT三种，但一般不用REJECT，会带来安全隐患</div><div class="line">注意：INPUT和DROP这样的关键字需要大写</div><div class="line">!</div><div class="line"></div><div class="line"><span class="comment">#禁止192.168.33.0网段从eth0网卡接入</span></div><div class="line">iptables -A INPUT -p tcp -i eth0 -s 192.168.33.0 -j DROP</div><div class="line">iptables -A INPUT -p tcp --dport 22 -i eth0 -s 192.168.33.61  -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment">#禁止ip地址非192.168.10.10的所有类型数据接入</span></div><div class="line">iptables -A INPUT ! -s 192.168.10.10 -j DROP</div><div class="line"></div><div class="line"><span class="comment">#禁止ip地址非192.168.10.10的ping请求</span></div><div class="line">iptables -I INPUT -p icmp --icmp-type 8 -s 192.168.50.100 -j DROP</div><div class="line"></div><div class="line"><span class="comment">#匹配端口范围</span></div><div class="line">iptables -I INPUT -p tcp --dport 22:80 -j DROP</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#匹配多个端口</span></div><div class="line">iptables -I INPUT -p tcp -m multiport --dport 22,80,3306 -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment">#不允许源端口为80的数据流出</span></div><div class="line">iptables -I OUTPUT -p tcp --sport 80 -j DROP</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Iptables也称作netfilter，是linux系统自带的防火墙工具，功能强大，使用灵活。在此记录下常用的命令及配置，以方便以后的使用。&lt;/p&gt;
&lt;h1 id=&quot;Iptables服务相关命令&quot;&gt;&lt;a href=&quot;#Iptables服务相关命令&quot; class=&quot;head
    
    </summary>
    
      <category term="linux" scheme="http://jollyfly.com/categories/linux/"/>
    
    
      <category term="linux" scheme="http://jollyfly.com/tags/linux/"/>
    
      <category term="防火墙" scheme="http://jollyfly.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
  </entry>
  
  <entry>
    <title>Spring事件驱动模型</title>
    <link href="http://jollyfly.com/2017/08/10/event/"/>
    <id>http://jollyfly.com/2017/08/10/event/</id>
    <published>2017-08-10T10:53:48.000Z</published>
    <updated>2017-09-04T01:29:55.305Z</updated>
    
    <content type="html"><![CDATA[<p>spring事件驱动模型，也叫做发布-订阅模型<br>一项业务或者某一服务，通常都会有一个主流程，同时还会包含很多附加操作。例如日志的记录、消息的推送或是邮件的发送等。<br><img src="/img/event2.jpg" alt="event"><br>这里的主流程和下面事件执行的内容，不在同一个事务中。将通用的业务内容通过这种方式拆分出来，从而达到解耦的目的。与AOP相比，这种方式更加灵活，通用性更强。同时，可以通过异步执行的方式，提交程序主流程的执行速度，降低服务的响应时间。<br>核心类图如下：<br><img src="/img/event3.png" alt="类图"><br>其实这是一个典型的观察者模式。<br>先看接口ApplicationEventPublisher<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationEventPublisher</span></span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(ApplicationEvent event)</span></span>;</div><div class="line">    <span class="comment">//由于spring4.2引入  如果传入的参数不是一个ApplicationEvent类型，就会将其包装</span></div><div class="line">    <span class="comment">//为PayloadApplicationEvent</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ApplicationContext是这个接口的子接口，那么所有ApplicationContext的实现类都会包含事件推送的功能。但是由于事件推送可能又不需要那么多方法。如果有ApplicationEventPublisher单一的实现类，那是极好的。于是在Spring中找到了这个类：ApplicationEventPublisherAware。既然是一个Aware，那就可以通过一个Set方法将需要的ApplicationEventPublisher的实例注入。</p>
<p>ApplicationListener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationListener</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(E event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>方法中实现Event事件的逻辑即可。</p>
<p>下面通过一个简单例子说明其基本用法<br>ApplicationEventPublisher：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationEventPublisher</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisher</span> , <span class="title">ApplicationEventPublisherAware</span></span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.applicationEventPublisher = applicationEventPublisher;  </div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.applicationEventPublisher.publishEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.applicationEventPublisher.publishEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LoginSuccessEvent:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginSuccessEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String username;</div><div class="line">        <span class="keyword">private</span> LocalDateTime loginTime;</div><div class="line">        <span class="keyword">private</span> String ipAddress;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginSuccessEvent</span><span class="params">(String username, LocalDateTime loginTime, String ipAddress)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">this</span>.username = username;</div><div class="line">        <span class="keyword">this</span>.loginTime = loginTime;</div><div class="line">        <span class="keyword">this</span>.ipAddress = ipAddress;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginSuccessEvent</span><span class="params">(Object source)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(source);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> username;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.username = username;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getLoginTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> loginTime;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTime</span><span class="params">(LocalDateTime loginTime)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.loginTime = loginTime;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIpAddress</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ipAddress;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIpAddress</span><span class="params">(String ipAddress)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ipAddress = ipAddress;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LoginListener:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">LoginSuccessEvent</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(LoginSuccessEvent event)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"发送邮件"</span>);</div><div class="line">        System.out.println(<span class="string">"记录日志："</span>+event.getIpAddress()+<span class="string">"..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LoginController:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span></span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> MyApplicationEventPublisher publisher;</div><div class="line">    </div><div class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/api/login"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> AppResult <span class="title">doLogin</span><span class="params">(Object... args)</span></span>&#123;</div><div class="line">        <span class="comment">//doSomething... 登录逻辑</span></div><div class="line">        publisher.publishEvent(<span class="keyword">new</span> LoginSuccessEvent(args));</div><div class="line">    &#125; </div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在Spring4.2中加入了注解的支持。类图如下：<br><img src="/img/event.jpg" alt="EventListener"><br>主要流程如下：<br>EventListenerMethodProcessor : 该类实现SmartInitializingSingleton接口，在所有单例类实例化完成后，调用其afterSingletonsInstantiated()方法，对所有bean进行扫扫描，记录带有@EventListener的方法 调用EventListenerFactory ，创建ApplicationListenerMethodAdapter 添加到applicationContext中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(LoginListener.class);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> LoginLogRepo loginLogRepo;</div><div class="line"></div><div class="line">    <span class="meta">@EventListener</span>(LoginSuccessEvent.class)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(LoginSuccessEvent event)</span></span>&#123;</div><div class="line">        String username = event.getUsername();</div><div class="line">        String ip = event.getIpAddress();</div><div class="line">		LocalDateTime loginTime = event.getLoginTime();</div><div class="line">        LoginLogPO log = <span class="keyword">new</span> LoginLogPO(UUID.randomUUID().toString(),loginTime,username,ip);</div><div class="line">        loginLogRepo.insert(log);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过注解进一步降低耦合度。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;spring事件驱动模型，也叫做发布-订阅模型&lt;br&gt;一项业务或者某一服务，通常都会有一个主流程，同时还会包含很多附加操作。例如日志的记录、消息的推送或是邮件的发送等。&lt;br&gt;&lt;img src=&quot;/img/event2.jpg&quot; alt=&quot;event&quot;&gt;&lt;br&gt;这里的主流程
    
    </summary>
    
      <category term="spring" scheme="http://jollyfly.com/categories/spring/"/>
    
    
      <category term="spring" scheme="http://jollyfly.com/tags/spring/"/>
    
      <category term="event" scheme="http://jollyfly.com/tags/event/"/>
    
  </entry>
  
  <entry>
    <title>链表问题总结</title>
    <link href="http://jollyfly.com/2017/07/19/linklist/"/>
    <id>http://jollyfly.com/2017/07/19/linklist/</id>
    <published>2017-07-19T01:10:20.000Z</published>
    <updated>2017-08-10T07:32:07.798Z</updated>
    
    <content type="html"><![CDATA[<p> 链表是非常常见的数据结构，是所有程序设计都比较基础的部分。因此将在复习过程中，将想过内容做一个总结。</p>
<h2 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h2><p>链表由若干个节点组成，每个节点中包含指向其下一个节点的指针，实例如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">    Object data;</div><div class="line">    Node next;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这些节点在物理存储单元上是非连续的，链表的数据插入的时间复杂度为O(1)<br>链表的插入思路如下：</p>
<ol>
<li>创建一个节点Node，包含数据</li>
<li>将上一个节点的next指向新建的节点</li>
<li>将新建节点的next指向原节点的下一个</li>
</ol>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line"> * 将给定的数据插入到给定节点的后面</div><div class="line"> * Node定义如上</div><div class="line"> */</div><div class="line">void linkafter(Node node,Object data)&#123;</div><div class="line">     //1. 创建一个节点Node，包含数据</div><div class="line">     Node newNode = new Node();</div><div class="line">     newNode.data = data;</div><div class="line">     Node next = node.next;</div><div class="line">     //2. 将上一个节点的next指向新建的节点</div><div class="line">     node.next = newNode;</div><div class="line">     //3. 将新建节点的next指向原节点的下一个</div><div class="line">     newNode.next = next;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因此在频繁对链表中数据进行操作是，使用这种数据结构能获得较高的性能</p>
<h2 id="单向链表和双向链表"><a href="#单向链表和双向链表" class="headerlink" title="单向链表和双向链表"></a>单向链表和双向链表</h2><p>单向链表即链表中的每一个节点包含其下一个的指针，如上面定义的节点。而双向链表则每个节点除了记录其下一个指针外，还会记录其上一个指针。例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">    Object data;</div><div class="line">    Node next;</div><div class="line">    Node prev;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在java中，LinkedList就是一个双向链表</p>
<h2 id="单向链表的转置"><a href="#单向链表的转置" class="headerlink" title="单向链表的转置"></a>单向链表的转置</h2><p>单向链表的转置意思就是讲一个单向链表，转换为其逆序的链表。<br>一般有两种思路:</p>
<ol>
<li><p>使用临时指针在链表上循环。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">* 参数head为指定要转置的链表的头指针，返回值为新链表的头指针</div><div class="line">*/</div><div class="line">Node reverse(Node head)&#123;</div><div class="line">    //链表中只有一个节点</div><div class="line">    if(head == null || head.next == null)&#123;</div><div class="line">        return head;</div><div class="line">    &#125;</div><div class="line">    Node pre = null;</div><div class="line">    Node next = null;</div><div class="line">    while(head != null)&#123;</div><div class="line">        next = head.next;</div><div class="line">        head.next = pre;</div><div class="line">        pree = head;</div><div class="line">        head = next;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>使用递归：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Node reverse(Node head)&#123;</div><div class="line">    if(head == null || head.next == null)&#123;</div><div class="line">        return head;</div><div class="line">    &#125;</div><div class="line">    Node newHead = reverse(head.next);</div><div class="line">    head.next.next = head;</div><div class="line">    head.next = null;</div><div class="line">    return newHead;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="链表环问题"><a href="#链表环问题" class="headerlink" title="链表环问题"></a>链表环问题</h2><p>链表有环即在链表中，有两个不同节点中的next指向同一个节点，则链表按照指针排下去，就会在链表中形成一个环状<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A -&gt; B -&gt; C -&gt; D -&gt; E -&gt; F -&gt; C</div></pre></td></tr></table></figure></p>
<p>B节点和F节点都会指向C节点，则C、D、E、F就会形成一个环状，指针在移动的时候会在这里一直循环</p>
<h3 id="判断一个链表是否有环"><a href="#判断一个链表是否有环" class="headerlink" title="判断一个链表是否有环"></a>判断一个链表是否有环</h3><p>根据以上分析，可以使用快慢指针法，快指针每次移动两步，慢指针每次移动一步。如果有环则两个指针一定会在环里相遇<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//head为第一个节点</div><div class="line">bool hasCricle(Node head)&#123;</div><div class="line">    Node slow;</div><div class="line">    Node fast;</div><div class="line">    slow = fast = head;</div><div class="line">    while(fast != null &amp;&amp; fast.next !=null)&#123;</div><div class="line">        // 移动两步</div><div class="line">        fast = fast.next.next;</div><div class="line">        //移动一步</div><div class="line">        slow = slow.next;</div><div class="line">        //相遇</div><div class="line">        if(fast == slow)&#123;</div><div class="line">            return true</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="判断一个链表是否有环并找出环入口"><a href="#判断一个链表是否有环并找出环入口" class="headerlink" title="判断一个链表是否有环并找出环入口"></a>判断一个链表是否有环并找出环入口</h3><p><strong>分析</strong>：首先根据上面的判断是否有环。假设有环，设起点head到环入口的距离为x步，设p1为慢指针，p2位快指针，p1与p2在环中的M节点相遇，M点距离环入口a步，环周长为L，p2比p1在环内多走k圈，两指针第一次相遇时假设p1走了n步，则：<br>p1走的步数: n = x + a;<br>p2走的步数：2n = x + a + k <em> L<br>两式相减：n = k </em> L = x + a<br>此时 若两指针都移动k<em>L-a步，就会在环口相遇，而k</em>L-a=x，即p2从头开始以步长1移动，当两指针再次相遇时，即为环口<br>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Node loopPort(Node head)&#123;</div><div class="line">    if(head == null || head.next == null)&#123;</div><div class="line">        return null;</div><div class="line">    &#125; </div><div class="line">    Node slow;</div><div class="line">    Node fast;</div><div class="line">    slow = fast = head;</div><div class="line">    while(fast != null &amp;&amp; fast.next !=null)&#123;</div><div class="line">        // 移动两步</div><div class="line">        fast = fast.next.next;</div><div class="line">        //移动一步</div><div class="line">        slow = slow.next;</div><div class="line">        //相遇</div><div class="line">        if(fast == slow)&#123;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //不存在环</div><div class="line">    if(fast != slow)&#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    //快指针从头开始</div><div class="line">    fast = head;</div><div class="line">    while(fast != slow)&#123;</div><div class="line">        fast = fast.next;</div><div class="line">        slow = slow.next;</div><div class="line">    &#125;</div><div class="line">    return fast;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt; 链表是非常常见的数据结构，是所有程序设计都比较基础的部分。因此将在复习过程中，将想过内容做一个总结。&lt;/p&gt;
&lt;h2 id=&quot;链表&quot;&gt;&lt;a href=&quot;#链表&quot; class=&quot;headerlink&quot; title=&quot;链表&quot;&gt;&lt;/a&gt;链表&lt;/h2&gt;&lt;p&gt;链表由若干个节点组成，
    
    </summary>
    
      <category term="编程基础" scheme="http://jollyfly.com/categories/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="数据结构" scheme="http://jollyfly.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="链表" scheme="http://jollyfly.com/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>Servlet基础</title>
    <link href="http://jollyfly.com/2017/07/16/servlet/"/>
    <id>http://jollyfly.com/2017/07/16/servlet/</id>
    <published>2017-07-16T01:10:20.000Z</published>
    <updated>2017-08-11T01:47:11.579Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Servlet接口中的方法"><a href="#Servlet接口中的方法" class="headerlink" title="Servlet接口中的方法"></a>Servlet接口中的方法</h1><ol>
<li><figure class="highlight plain"><figcaption><span>init(ServletConfig config) throws ServletException;```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">init方法在servlet对象创建时执行</div><div class="line">@parm config 代表该servlet对象</div><div class="line"></div><div class="line">2. ```void service(ServletRequest request,ServletResponse response)``` </div><div class="line">service方法在每次请求时执行</div><div class="line">@parm request 内部封装请求信息</div><div class="line">@parm response 内部封装响应信息</div><div class="line"></div><div class="line">3. ```void destroy()</div></pre></td></tr></table></figure>
</li>
</ol>
<p>在servlet销毁的时候执行</p>
<h1 id="HttpServlet"><a href="#HttpServlet" class="headerlink" title="HttpServlet"></a>HttpServlet</h1><p> 在用自己写Servlet时，通常是继承这个类，实现其中的doGet、doPost等方法</p>
<h2 id="关于restful"><a href="#关于restful" class="headerlink" title="关于restful"></a>关于restful</h2><p>JAX-RS是java的REST服务规范，由javaEE6引入。<br>restful通过四种请求：POST、DELETE、PUT、GET分别对应对服务器资源的增删改查操作。</p>
<h2 id="url-pattern的配置"><a href="#url-pattern的配置" class="headerlink" title="url-pattern的配置"></a>url-pattern的配置</h2><ol>
<li>完全路径匹配   /</li>
<li>目录匹配 以/开始，需要以<em>结束  例如：/aaa/bbb/</em></li>
<li>扩展名匹配 不能以/开始  以<em>开始  例如 </em>.do   <em>.json   </em>.xml    错误写法  /*.do</li>
<li>缺省路径  /<br>通常情况下，访问html页面时，首先从当前web项目的web.xml文件寻找匹配路径，如果没有找到 再从tomcat默认的web.xml配置，将使用缺省servlet<br>tomcat获取匹配路径时优先级顺序为 1〉2〉3〉4</li>
</ol>
<h2 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h2><p>服务器启动的时候，会为每个WEB应用创建一个单独的ServletContext对象。可使用如下方法向ServletContext中存取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//存数据</div><div class="line">void setAttribute(String name,Object obj)</div><div class="line">//取数据</div><div class="line">Object getAttribute(String name)</div><div class="line">//移除数据</div><div class="line">void removeAttribute(String name)</div></pre></td></tr></table></figure>
<h2 id="ServletConfig-获取Servlet的配置信息"><a href="#ServletConfig-获取Servlet的配置信息" class="headerlink" title="ServletConfig 获取Servlet的配置信息"></a>ServletConfig 获取Servlet的配置信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String getInitParameter(String name);</div><div class="line">Enumeration&lt;String&gt; getInitParameterNames();</div><div class="line">ServletContext getServletContext();</div><div class="line">String getServletName();</div></pre></td></tr></table></figure>
<h1 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h1><h2 id="JSP内置对象"><a href="#JSP内置对象" class="headerlink" title="JSP内置对象"></a>JSP内置对象</h2><table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">out</td>
<td style="text-align:center">javax.servlet.jsp.JspWriter</td>
<td style="text-align:center">用于页面输出</td>
</tr>
<tr>
<td style="text-align:center">request</td>
<td style="text-align:center">javax.servlet.http<br>.HttpServletRequest</td>
<td style="text-align:center">得到用户请求信息</td>
</tr>
<tr>
<td style="text-align:center">response</td>
<td style="text-align:center">javax.servlet.http<br>.HttpServletResponse</td>
<td style="text-align:center">服务器向客户端的响应信息</td>
</tr>
<tr>
<td style="text-align:center">config</td>
<td style="text-align:center">javax.servlet.ServletConfig</td>
<td style="text-align:center">服务器配置，可以取得初始化参数</td>
</tr>
<tr>
<td style="text-align:center">session</td>
<td style="text-align:center">javax.servlet.http.HttpSession</td>
<td style="text-align:center">保存用户信息</td>
</tr>
<tr>
<td style="text-align:center">application</td>
<td style="text-align:center">javax.servlet.ServletContext</td>
<td style="text-align:center">保存所有用户共享的信息</td>
</tr>
<tr>
<td style="text-align:center">page</td>
<td style="text-align:center">java.lang.Object</td>
<td style="text-align:center">指当前页面转换后的Servlet类的实例</td>
</tr>
<tr>
<td style="text-align:center">pageContext</td>
<td style="text-align:center">javax.servlet.jsp.PageContext</td>
<td style="text-align:center">jsp页面的容器</td>
</tr>
<tr>
<td style="text-align:center">exception</td>
<td style="text-align:center">java.lang.Throwable</td>
<td style="text-align:center">表示JSP页面所发生的异常，在错误页中才起作用</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Servlet接口中的方法&quot;&gt;&lt;a href=&quot;#Servlet接口中的方法&quot; class=&quot;headerlink&quot; title=&quot;Servlet接口中的方法&quot;&gt;&lt;/a&gt;Servlet接口中的方法&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;&lt;figure class=&quot;highl
    
    </summary>
    
      <category term="java基础" scheme="http://jollyfly.com/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="servlet" scheme="http://jollyfly.com/tags/servlet/"/>
    
  </entry>
  
  <entry>
    <title>使用AOP实现数据库读写分离</title>
    <link href="http://jollyfly.com/2017/07/15/rwseparate/"/>
    <id>http://jollyfly.com/2017/07/15/rwseparate/</id>
    <published>2017-07-15T01:00:48.000Z</published>
    <updated>2017-07-19T10:04:32.521Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>项目中在读写分离以及分库分表方面用的是中间件，对于mysql来说有很多中间件支持，例如mysql-proxy、mycat。其中mycat除了支持mysql，还支持很多常见的数据库。除了中间件还有一些框架也能支持读写分离及分库，例如当当开源的sharding-jdbc，从代码层面进行控制。<br>对于读写分离，其本质是对程序在运行时所使用的数据源的控制。本次主要以mysql为例记录使用AOP在代码层面实现读<br>写分离。</p>
</blockquote>
<h2 id="配置MYSQL主从复制（以windows为例）"><a href="#配置MYSQL主从复制（以windows为例）" class="headerlink" title="配置MYSQL主从复制（以windows为例）"></a>配置MYSQL主从复制（以windows为例）</h2><p>注意事项：<br>要主库和从库的mysql版本需要一致</p>
<h3 id="配置主库"><a href="#配置主库" class="headerlink" title="配置主库"></a>配置主库</h3><h4 id="修改mysql目录下的my-ini"><a href="#修改mysql目录下的my-ini" class="headerlink" title="修改mysql目录下的my.ini"></a>修改mysql目录下的my.ini</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log-bin=mysql3308-bin</div><div class="line">#server-id必须是唯一的</div><div class="line">server-id=101</div><div class="line">#指定要同步的数据库，如果不指定则同步所有数据库</div><div class="line">binlog-do-db=test</div></pre></td></tr></table></figure>
<p>修改完成后重启数据库，执行SQL查询状态<br>    show master status<br><img src="/img/rw1.png" alt="查询状态"></p>
<p>需要记录下Position的值，在从库中设置同步起始值</p>
<h4 id="在主库创建用于同步数据的用户"><a href="#在主库创建用于同步数据的用户" class="headerlink" title="在主库创建用于同步数据的用户"></a>在主库创建用于同步数据的用户</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">grant</span> <span class="keyword">replication</span> <span class="keyword">slave</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'127.0.0.1'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span>;</div><div class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</div></pre></td></tr></table></figure>
<h3 id="配置从库"><a href="#配置从库" class="headerlink" title="配置从库"></a>配置从库</h3><h4 id="修改my-ini"><a href="#修改my-ini" class="headerlink" title="修改my.ini"></a>修改my.ini</h4><pre><code>server-id=102
</code></pre><p>执行以下SQL<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#master_log_file和master_log_pos要和上面查询出来的对应</div><div class="line">CHANGE MASTER TO</div><div class="line"> master_host='127.0.0.1',</div><div class="line"> master_user='slave01',</div><div class="line"> master_password='123456',</div><div class="line"> master_port=3308,</div><div class="line"> master_log_file='mysql3306-bin.000005',</div><div class="line"> master_log_pos=154;</div></pre></td></tr></table></figure></p>
<p>启动slave同步：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">startslave</div></pre></td></tr></table></figure></p>
<p>查看同步状态<br>show slave status<br><img src="/img/rw2.png" alt="从库状态"><br>图中标记的两项只要为yes就说明配置成功</p>
<h2 id="使用AOP实现读写分离"><a href="#使用AOP实现读写分离" class="headerlink" title="使用AOP实现读写分离"></a>使用AOP实现读写分离</h2><blockquote>
<p>基本思路为,定义注解，通过AOP拦截被注解的方法，在进入service之前，标记要使用的数据源，继承AbstractRoutingDataSource作为mybaits的数据源，实现其中的determineCurrentLookupKey()方法，根据标记返回不同的key，父类根据这个方法返回的不同key使用不同的真实数据源。<br>本次基于springboot+mybatis框架。</p>
</blockquote>
<h3 id="定义注解-DataSourceType"><a href="#定义注解-DataSourceType" class="headerlink" title="定义注解@DataSourceType"></a>定义注解@DataSourceType</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataSourceType &#123;</div><div class="line">    <span class="function">Type <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> Type.MASTER</span>;</div><div class="line">    <span class="comment">//使用枚举限制使用注解时填写的value值</span></div><div class="line">    <span class="keyword">enum</span> Type &#123;</div><div class="line">        MASTER,</div><div class="line">        SLAVE</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h3><blockquote>
<p>本次数据源配置使用springboot自定义配置，方便扩展。重点记录读写分离的实现，至于springboot与mybatis整合可参考其他资料<br>数据源配置为一主多从</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="attr">me:</span></div><div class="line"><span class="attr">    jollyfly:</span></div><div class="line"><span class="attr">        datasource:</span></div><div class="line">            <span class="comment">#主库（写库）数据源</span></div><div class="line"><span class="attr">            master:</span></div><div class="line"><span class="attr">                - node:</span></div><div class="line"><span class="attr">                  url:</span> <span class="attr">jdbc:mysql://localhost:3308/test?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line"><span class="attr">                  password:</span> <span class="number">123456</span></div><div class="line"><span class="attr">                  username:</span> <span class="string">root</span></div><div class="line"><span class="attr">                  type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></div><div class="line"><span class="attr">                  driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line">            <span class="comment">#从库（读库）数据源，可增加节点配置实现扩展。使用Druid连接池</span></div><div class="line"><span class="attr">            slaves:</span></div><div class="line"><span class="attr">                - node:</span></div><div class="line"><span class="attr">                  url:</span> <span class="attr">jdbc:mysql://localhost:3408/test?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line"><span class="attr">                  password:</span> <span class="number">123456</span></div><div class="line"><span class="attr">                  username:</span> <span class="string">root</span></div><div class="line"><span class="attr">                  type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></div><div class="line"><span class="attr">                  driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"></div><div class="line"><span class="attr">                - node:</span></div><div class="line"><span class="attr">                  driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"><span class="attr">                  url:</span> <span class="attr">jdbc:mysql://localhost:3508/test?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line"><span class="attr">                  password:</span> <span class="number">123456</span></div><div class="line"><span class="attr">                  username:</span> <span class="string">root</span></div><div class="line"><span class="attr">                  type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></div><div class="line"></div><div class="line"><span class="attr">                - node:</span></div><div class="line"><span class="attr">                  driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"><span class="attr">                  url:</span> <span class="attr">jdbc:mysql://localhost:3608/test?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line"><span class="attr">                  password:</span> <span class="number">123456</span></div><div class="line"><span class="attr">                  username:</span> <span class="string">root</span></div><div class="line"><span class="attr">                  type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></div></pre></td></tr></table></figure>
<h3 id="加载自定义数据源配置"><a href="#加载自定义数据源配置" class="headerlink" title="加载自定义数据源配置"></a>加载自定义数据源配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"me.jollyfly.datasource"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Node&gt; slaves = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Node&gt; master = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Node&gt; <span class="title">getSlaves</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> slaves;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Node&gt; <span class="title">getMaster</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> master;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//定义Node类接收node节点的配置</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> String driverClassName;</div><div class="line">        <span class="keyword">private</span> String url;</div><div class="line">        <span class="keyword">private</span> String username;</div><div class="line">        <span class="keyword">private</span> String password;</div><div class="line">        <span class="keyword">private</span> String type;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getDriverClassName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> driverClassName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDriverClassName</span><span class="params">(String driverClassName)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.driverClassName = driverClassName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> url;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.url = url;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> username;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.username = username;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> password;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.password = password;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> type;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(String type)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.type = type;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="配置mybatis"><a href="#配置mybatis" class="headerlink" title="配置mybatis"></a>配置mybatis</h3><blockquote>
<p>需要配置SqlSessionFactory执定使用的数据源为动态数据源</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@MapperScan</span>(<span class="string">"me.jollyfly.learn.mapper"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisConfig</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MyBatisConfig.class);</div><div class="line">    <span class="comment">//注入上面的配置类</span></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> DataSourceConfig dataSourceConfig;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//配置sqlSessionFactory，指定数据源</span></div><div class="line">    <span class="meta">@Bean</span>(name = <span class="string">"sqlSessionFactory"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactory</span><span class="params">()</span></span>&#123;</div><div class="line">        Assert.notNull(dataSource(),<span class="string">"请检查数据源配置"</span>);</div><div class="line">        SqlSessionFactoryBean factoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</div><div class="line">        factoryBean.setDataSource(<span class="keyword">this</span>.dataSource());</div><div class="line">        factoryBean.setTypeAliasesPackage(<span class="string">"me.jollyfly.learn.entity"</span>);</div><div class="line">        ResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            factoryBean.setMapperLocations(resolver.getResources(<span class="string">"classpath:mapper/*.xml"</span>));</div><div class="line">            <span class="keyword">return</span> factoryBean.getObject();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.error(<span class="string">"未找到mapper文件"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//所有的数据源</span></div><div class="line">    <span class="meta">@Bean</span>(<span class="string">"dataSources"</span>)</div><div class="line">    <span class="meta">@Qualifier</span>(<span class="string">"dataSources"</span>)</div><div class="line">    <span class="keyword">public</span> DataSource[] dataSources()&#123;</div><div class="line">        List&lt;DataSource&gt; dataSources = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</div><div class="line">        <span class="keyword">this</span>.dataSourceConfig.getSlaves().forEach(node-&gt;&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                DataSource dataSource = DataSourceBuilder.create()</div><div class="line">                        .driverClassName(node.getDriverClassName())</div><div class="line">                        .url(node.getUrl())</div><div class="line">                        .username(node.getUsername())</div><div class="line">                        .password(node.getPassword())</div><div class="line">                        .type((Class&lt;DataSource&gt;)Class.forName(node.getType()))</div><div class="line">                        .build();</div><div class="line">                dataSources.add(dataSource);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                logger.error(<span class="string">"从库数据源配置有误"</span>,e);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;);</div><div class="line">        List&lt;DataSourceConfig.Node&gt; masterNodes = <span class="keyword">this</span>.dataSourceConfig.getMaster();</div><div class="line">        Assert.notEmpty(masterNodes,<span class="string">"请配置master数据源"</span>);</div><div class="line">        <span class="keyword">if</span> (masterNodes.size()!=<span class="number">1</span>)&#123;</div><div class="line">            <span class="comment">//主库只能有一个</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DuplicateMasterException(<span class="string">"重复的master数据源"</span>);</div><div class="line">        &#125;</div><div class="line">        DataSourceConfig.Node node = masterNodes.get(<span class="number">0</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            DataSource masterDataSource = DataSourceBuilder.create()</div><div class="line">                    .driverClassName(node.getDriverClassName())</div><div class="line">                    .url(node.getUrl())</div><div class="line">                    .username(node.getUsername())</div><div class="line">                    .password(node.getPassword())</div><div class="line">                    .type((Class&lt;DataSource&gt;)Class.forName(node.getType()))</div><div class="line">                    .build();</div><div class="line">            dataSources.add(masterDataSource);</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            logger.error(<span class="string">"主库数据源配置有误"</span>,e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"主库数据源配置有误"</span>,e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> dataSources.toArray(<span class="keyword">new</span> DataSource[dataSources.size()]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//配置DynamicDataSource</span></div><div class="line">    <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</div><div class="line">    <span class="meta">@Qualifier</span>(<span class="string">"dataSource"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span></span>&#123;</div><div class="line">        DynamicDataSource dataSource =<span class="keyword">new</span> DynamicDataSource();</div><div class="line">        Map&lt;Object,Object&gt; targetDataSource = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">3</span>);</div><div class="line">        List&lt;DataSource&gt; dataSources = Arrays.asList(dataSources());</div><div class="line">        Assert.notNull(dataSources.get(<span class="number">0</span>),<span class="string">"请检查数据源配置"</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;dataSources.size();i++)&#123;</div><div class="line">            <span class="keyword">if</span> (i == dataSources.size()-<span class="number">1</span>)&#123;</div><div class="line">                targetDataSource.put(DataSourceType.Type.MASTER,dataSources.get(i));</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            targetDataSource.put(<span class="string">"slave"</span>+i,dataSources.get(i));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        dataSource.setTargetDataSources(targetDataSource);</div><div class="line">        dataSource.setDefaultTargetDataSource(dataSources.get(<span class="number">0</span>));</div><div class="line">        <span class="keyword">return</span> dataSource;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="定义动态数据源继承AbstractRoutingDataSource"><a href="#定义动态数据源继承AbstractRoutingDataSource" class="headerlink" title="定义动态数据源继承AbstractRoutingDataSource"></a>定义动态数据源继承AbstractRoutingDataSource</h3><blockquote>
<p>使用轮询的方式使用不同的读库</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DynamicDataSource.class);</div><div class="line"></div><div class="line">    <span class="comment">//使用AtomicInteger来计数实现轮询，保证计数操作原子性</span></div><div class="line">    <span class="keyword">private</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(-<span class="number">1</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 所有的从库数据源</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> List&lt;Object&gt; slaveDataSources = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DynamicDataSourceHolder.isMaster()) &#123;</div><div class="line">            Object key = DynamicDataSourceHolder.getDataSourceKey();</div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"当前数据源key为 &#123;&#125;"</span>, key);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> key;</div><div class="line">        &#125;</div><div class="line">        Object key = getSlaveKey();</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"当前数据源key为 &#123;&#125;"</span>, key);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> key;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 重写次方法完成slaveDataSources的初始化</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.afterPropertiesSet();</div><div class="line">        <span class="comment">//通过反射获取父类的resolvedDataSources</span></div><div class="line">        Field field = ReflectionUtils.findField(AbstractRoutingDataSource.class, <span class="string">"resolvedDataSources"</span>);</div><div class="line">        <span class="comment">//私有属性，设置为可见</span></div><div class="line">        field.setAccessible(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Map&lt;Object, DataSource&gt; resolvedDataSources = (Map&lt;Object, DataSource&gt;) field.get(<span class="keyword">this</span>);</div><div class="line">            <span class="comment">//去除key为MASTER的元素，然后遍历将过滤后的元素添加到slaveDataSource</span></div><div class="line">            resolvedDataSources.keySet().stream().filter(key -&gt; !DataSourceType.Type.MASTER.equals(key))</div><div class="line">                    .forEach(key -&gt; slaveDataSources.add(key));</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 轮询获取当前从库的key</div><div class="line">     * <span class="doctag">@return</span> 从库的Key</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSlaveKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//自增</span></div><div class="line">        Integer index = counter.incrementAndGet();</div><div class="line">        <span class="comment">//防止超过int最大值</span></div><div class="line">        <span class="keyword">if</span> (counter.get() &gt; <span class="number">9999</span>) &#123;</div><div class="line">            counter.set(-<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> slaveDataSources.get(index);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="定义DynamicDataSourceHolder记录要使用的数据源"><a href="#定义DynamicDataSourceHolder记录要使用的数据源" class="headerlink" title="定义DynamicDataSourceHolder记录要使用的数据源"></a>定义DynamicDataSourceHolder记录要使用的数据源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DynamicDataSource.class);</div><div class="line"></div><div class="line">    <span class="comment">//使用AtomicInteger来计数实现轮询，保证计数操作原子性</span></div><div class="line">    <span class="keyword">private</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(-<span class="number">1</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 所有的从库数据源</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> List&lt;Object&gt; slaveDataSources = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DynamicDataSourceHolder.isMaster()) &#123;</div><div class="line">            Object key = DynamicDataSourceHolder.getDataSourceKey();</div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"当前数据源key为 &#123;&#125;"</span>, key);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> key;</div><div class="line">        &#125;</div><div class="line">        Object key = getSlaveKey();</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"当前数据源key为 &#123;&#125;"</span>, key);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> key;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 重写次方法完成slaveDataSources的初始化</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.afterPropertiesSet();</div><div class="line">        <span class="comment">//通过反射获取父类的resolvedDataSources</span></div><div class="line">        Field field = ReflectionUtils.findField(AbstractRoutingDataSource.class, <span class="string">"resolvedDataSources"</span>);</div><div class="line">        <span class="comment">//私有属性，设置为可见</span></div><div class="line">        field.setAccessible(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Map&lt;Object, DataSource&gt; resolvedDataSources = (Map&lt;Object, DataSource&gt;) field.get(<span class="keyword">this</span>);</div><div class="line">            <span class="comment">//去除key为MASTER的元素，然后遍历将过滤后的元素添加到slaveDataSource</span></div><div class="line">            resolvedDataSources.keySet().stream().filter(key -&gt; !DataSourceType.Type.MASTER.equals(key))</div><div class="line">                    .forEach(key -&gt; slaveDataSources.add(key));</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 轮询获取当前从库的key</div><div class="line">     * <span class="doctag">@return</span> 从库的Key</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSlaveKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//自增</span></div><div class="line">        Integer index = counter.incrementAndGet();</div><div class="line">        <span class="comment">//防止超过int最大值</span></div><div class="line">        <span class="keyword">if</span> (counter.get() &gt; <span class="number">9999</span>) &#123;</div><div class="line">            counter.set(-<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> slaveDataSources.get(index);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="定义数据源切面"><a href="#定义数据源切面" class="headerlink" title="定义数据源切面"></a>定义数据源切面</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 定义切面，拦截所有带有DataSourceType注解的方法</div><div class="line">     */</div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(me.jollyfly.learn.aop.DataSourceType)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceAspect</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在进入带注解的方法前，根据注解切换数据源</div><div class="line">     * <span class="doctag">@param</span> point</div><div class="line">     */</div><div class="line">    <span class="meta">@Before</span>(<span class="string">"serviceAspect()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint point)</span> </span>&#123;</div><div class="line">        MethodSignature methodSignature = (MethodSignature) point.getSignature();</div><div class="line">        <span class="comment">//获取该方法注解value</span></div><div class="line">        DataSourceType.Type type = methodSignature.getMethod().getAnnotation(DataSourceType.class).value();</div><div class="line">        <span class="keyword">if</span> (DataSourceType.Type.MASTER.equals(type)) &#123;</div><div class="line">            <span class="comment">//标记为主</span></div><div class="line">            DynamicDataSourceHolder.markMaster();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//标记为从</span></div><div class="line">            DynamicDataSourceHolder.markSlave();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="在service中使用注解"><a href="#在service中使用注解" class="headerlink" title="在service中使用注解"></a>在service中使用注解</h3><blockquote>
<p>对于userMapper和其对应的userMapper.xml以及实体类User省略</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserMapper userMapper;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@DataSourceType</span>(DataSourceType.Type.SLAVE)</div><div class="line">    <span class="meta">@Transactional</span>(readOnly = <span class="keyword">true</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> userMapper.findAll();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果不加注解，则默认使用master</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@Transactional</span>(readOnly = <span class="keyword">true</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(Long id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> userMapper.findById(id);</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@DataSourceType</span>(DataSourceType.Type.MASTER)</div><div class="line">    <span class="meta">@Transactional</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">        userMapper.save(user);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span></span>&#123;</div><div class="line">    <span class="comment">//注入userService</span></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserService userService;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUserService</span><span class="params">()</span></span>&#123;</div><div class="line">        List&lt;User&gt; users = userService.findAll();</div><div class="line">        User user = userService.findById(<span class="number">1L</span>);</div><div class="line">        User u = <span class="keyword">new</span> User();</div><div class="line">        u.setUsername(<span class="string">"aaa"</span>);</div><div class="line">        u.setPassword(<span class="string">"bbb"</span>);</div><div class="line">        userService.save(u);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>测试用例正常运行，可看到控制台的使用不同数据源的日志</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用AOP控制读写分离，通过注解的方式，不会破坏原有代码的执行，使用注解的方式，几乎零成本的改动。但是这种方式相比较于用中间件或者使用sharding-jdbc这种成熟的框架来说，少了很多功能，但是是成本最低的实现方式。</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;项目中在读写分离以及分库分表方面用的是中间件，对于mysql来说有很多中间件支持，例如mysql-proxy、mycat。其中mycat除了支持mysql，还支持很多常见的数据库。除了中间件还有一些框架也能支持读写分离及分库，例如当当开源的shar
    
    </summary>
    
      <category term="spring" scheme="http://jollyfly.com/categories/spring/"/>
    
    
      <category term="数据库" scheme="http://jollyfly.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="读写分离" scheme="http://jollyfly.com/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/"/>
    
      <category term="aop" scheme="http://jollyfly.com/tags/aop/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot使用Spring Data JPA</title>
    <link href="http://jollyfly.com/2017/07/13/springbootjpa/"/>
    <id>http://jollyfly.com/2017/07/13/springbootjpa/</id>
    <published>2017-07-13T07:23:48.000Z</published>
    <updated>2017-08-28T07:09:04.144Z</updated>
    
    <content type="html"><![CDATA[<h2 id="关于jpa"><a href="#关于jpa" class="headerlink" title="关于jpa"></a>关于jpa</h2><blockquote>
<p>JPA(Java Persistence API)是Sun公司官方提出来的Java持久化规范。JPA指的是一种规范并不是一种产品。Spring<br>Data JPA是Spring在ORM框架、JPA基础上封装的一套JPA应用框架。</p>
</blockquote>
<h3 id="JpaRepository接口"><a href="#JpaRepository接口" class="headerlink" title="JpaRepository接口"></a>JpaRepository接口</h3><p>Spring Data JPA预先提供了一些基本的CRUD的方法，继承这个接口，就可以直接使用预先提供的方法，非常的方便。<br>除了使用预先提供好的方法，Spring Data JPA还可以通过方法名，根据方法名所表达的意思自动完成方法的实现。除此<br>之外，还可以通过注解写自定义SQL。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>首先新建一个SpringBoot工程，POM文件引入以下依赖。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">      <span class="comment">&lt;!--Spring Data JPA依赖--&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--MySQL数据库驱动--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">      		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!--druid数据库连接池--&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>配置application.properties<br>我这里使用的是yml格式的文件做配置：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">    jpa:</span></div><div class="line"><span class="attr">        generate-ddl:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        database:</span> <span class="string">mysql</span></div><div class="line"><span class="attr">        show-sql:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    datasource:</span></div><div class="line"><span class="attr">        driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"><span class="attr">        url:</span> <span class="attr">jdbc:mysql://localhost:3308/test?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line"><span class="attr">        password:</span> <span class="number">123456</span></div><div class="line"><span class="attr">        username:</span> <span class="string">root</span></div><div class="line"><span class="attr">        type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></div></pre></td></tr></table></figure></p>
<p>这里的spring.jpa.gengerate-ddl设置为true后，在应用启动后会自动根据有jpa注解的实体类进行表的ddl</p>
<p>新建实体类User.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Table</span>(name = <span class="string">"t_base_user"</span>)</div><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="meta">@Id</span></div><div class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY )</div><div class="line">    <span class="keyword">private</span> Long id;</div><div class="line">    <span class="meta">@Column</span>(name = <span class="string">"username"</span>, unique = <span class="keyword">true</span>, length = <span class="number">64</span> , columnDefinition = <span class="string">"用户名"</span>)</div><div class="line">    <span class="keyword">private</span> String username;</div><div class="line">    <span class="meta">@Column</span>(name = <span class="string">"password"</span>, length = <span class="number">64</span> , columnDefinition = <span class="string">"密码"</span>)</div><div class="line">    <span class="keyword">private</span> String password;</div><div class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> gender;   <span class="comment">// 性别</span></div><div class="line"></div><div class="line">    <span class="meta">@Column</span>(name = <span class="string">"email"</span>, unique = <span class="keyword">true</span>, length = <span class="number">128</span>)</div><div class="line">    <span class="keyword">private</span> String email;  <span class="comment">// 邮箱</span></div><div class="line"></div><div class="line">    <span class="meta">@Column</span>(name = <span class="string">"mobile"</span>, length = <span class="number">11</span>)</div><div class="line">    <span class="keyword">private</span> String mobile;  <span class="comment">// 手机号</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> Date created;</div><div class="line"></div><div class="line">    <span class="comment">//省略get和set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建数据库操作类UserRepo.java,继承JpaRepository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * 这里的两个泛型第一个是对应的实体类，第二个是主键的类型，一般为Long或者String</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepo</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt;</span>&#123;</div><div class="line">    <span class="comment">//自定义简单查询，根据方法名来自动生成SQL</span></div><div class="line">    <span class="comment">//当使用idea是，在这里可以智能提示方法名</span></div><div class="line">    <span class="function">User <span class="title">findByEmail</span><span class="params">(String email)</span></span>;</div><div class="line">    <span class="comment">//自定义sql查询，可以满足更加复杂的查询需求</span></div><div class="line">    <span class="meta">@Modifying</span></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"update User u set u.username = ?1 where u.id = ?2"</span>)</div><div class="line">    <span class="meta">@Transactional</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateUsernameById</span><span class="params">(String username, Long id)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面写一个测试类，演示一些接口自带的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserRepo userRepo;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUserRepo</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="comment">//演示&lt;S extends T&gt; Page&lt;S&gt; findAll(Example&lt;S&gt; example, Pageable pageable);的用法</span></div><div class="line">	    <span class="comment">//根据给出的查询条件封装到User中，进行分页查询</span></div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setEmail(<span class="string">"abc@123.com"</span>);</div><div class="line">        Example&lt;User&gt;  example = Example.of(user);</div><div class="line">        Pageable pageable = <span class="keyword">new</span> PageRequest(<span class="number">1</span>,<span class="number">2</span>);</div><div class="line">        Page&lt;User&gt; userPage = <span class="keyword">this</span>.userRepo.findAll(example, pageable);</div><div class="line">        <span class="comment">//可根据Page对象拿到当前页的数据</span></div><div class="line">        List&lt;User&gt; list =  userPage.getContent();</div><div class="line">        <span class="comment">//测试排序</span></div><div class="line">        Sort orders = <span class="keyword">new</span> Sort(<span class="string">"username"</span>,<span class="string">"created"</span>);</div><div class="line">        List&lt;User&gt; userList1= <span class="keyword">this</span>.userRepo.findAll(orders);</div><div class="line">        <span class="comment">//测试自定义简单查询</span></div><div class="line">        User result = <span class="keyword">this</span>.userRepo.findByEmail(<span class="string">"abc@123.com"</span>);</div><div class="line">        <span class="comment">//测试自定义sql</span></div><div class="line">        <span class="keyword">int</span> resultCount = <span class="keyword">this</span>.userRepo.updateUsernameById(<span class="string">"ccc"</span>, <span class="number">2L</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Sping Data JPA是一个完全符合JPA规范的框架，也有像Hibernate一样的延迟加载机制，类似于Hibernate，上手要求要高于Mybatis很多，对于很多关联查询，Mybatis可以自己写SQL，对性能的把控更好，也更加灵活。Mybatis目前也有许多第三方的插件，同样可以方便的实现分页及通用Mapper，提供公共的单表操作的API。总的来说，如果对Spring Data JPA没有特别深入的了解，还是使用Mybatis更加可靠。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;关于jpa&quot;&gt;&lt;a href=&quot;#关于jpa&quot; class=&quot;headerlink&quot; title=&quot;关于jpa&quot;&gt;&lt;/a&gt;关于jpa&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;JPA(Java Persistence API)是Sun公司官方提出来的Java持久化规
    
    </summary>
    
      <category term="springboot" scheme="http://jollyfly.com/categories/springboot/"/>
    
    
      <category term="jpa" scheme="http://jollyfly.com/tags/jpa/"/>
    
      <category term="springboot" scheme="http://jollyfly.com/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>Lock和synchronized</title>
    <link href="http://jollyfly.com/2017/07/11/javalock/"/>
    <id>http://jollyfly.com/2017/07/11/javalock/</id>
    <published>2017-07-11T07:42:34.000Z</published>
    <updated>2017-09-11T01:49:51.971Z</updated>
    
    <content type="html"><![CDATA[<p> 在java中lock和synchronized都可以实现对程序的同步控制，但是在不同的场景有不同的性能表现。</p>
<h2 id="Lock和synchronized的区别"><a href="#Lock和synchronized的区别" class="headerlink" title="Lock和synchronized的区别"></a>Lock和synchronized的区别</h2><h3 id="Lock接口"><a href="#Lock接口" class="headerlink" title="Lock接口"></a>Lock接口</h3><p>Lock是jdk中java.util.concurrent.locks包中的一个接口，常用的实现类为ReentrantLock。<br>在Lock接口中主要提供了以下方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//如果获取了锁立即返回，如果别的线程持有锁，当前线程则一直处于休眠状态，直到获取锁。</div><div class="line">void lock();</div><div class="line">//如果获取了锁定立即返回，如果没有获取锁定，当前线程处于休眠状态，直到或者锁定，或者当前线程被别的线程中断</div><div class="line">void lockInterruptibly() throws InterruptedException;</div><div class="line">//如果获取了锁立即返回true，如果别的线程正持有锁，立即回false</div><div class="line">boolean tryLock();</div><div class="line">/*如果获取了锁定立即返回true，如果别的线程正持有锁，会等待</div><div class="line">*参数给定的时间，在等待的过程中，如果获取了锁定，就返回true，</div><div class="line">*如果等待超时，返回false</div><div class="line">*/</div><div class="line">boolean tryLock(long time, TimeUnit unit) throws InterruptedException;</div><div class="line">//释放锁</div><div class="line">void unlock();</div></pre></td></tr></table></figure></p>
<p>可以看出，synchronized是系统提供的关键字，而Lock是jdk给的接口，因此synchronized是在JVM的层<br>面上实现的，在代码执行出现异常的时候，JVM会自动释放锁，而Lock是使用代码来实现锁的功能，因此需要在<br>finally中对锁进行释放。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt; 在java中lock和synchronized都可以实现对程序的同步控制，但是在不同的场景有不同的性能表现。&lt;/p&gt;
&lt;h2 id=&quot;Lock和synchronized的区别&quot;&gt;&lt;a href=&quot;#Lock和synchronized的区别&quot; class=&quot;headerli
    
    </summary>
    
      <category term="多线程" scheme="http://jollyfly.com/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="lock  并发" scheme="http://jollyfly.com/tags/lock-%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Java中Volatile关键字详解</title>
    <link href="http://jollyfly.com/2017/07/08/volatile/"/>
    <id>http://jollyfly.com/2017/07/08/volatile/</id>
    <published>2017-07-08T07:50:28.000Z</published>
    <updated>2017-07-11T07:35:14.353Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>volatile是java中的关键字，在涉及到并发编程时会用到，特地对其特点进行学习与总结，以更好的理解其<br>应用场景以及其中的原理。</p>
</blockquote>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><p>volatile的意思是易变的，不稳定的。这个关键字在java中常用在并发编程中。要想理解这个关键字，首先了解以下<br>三个概念。</p>
<h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p>原子性这个概念在很多地方都会出现，其概念很多人都很熟悉，但是真正理解，还是要费点时间的。原子性就是在一个或<br>多个操作中，要么全部执行并且执行的过程是不被其他因素干扰打断的，要么所有操作都不执行。举个简单的例子：<br>i = i + 1,这个操作并不是原子性操作，在执行这句话的时候，会分为三步。1.先取出i的值 2.将i的值加一 3.写入<br>新的值。因此这个语句的操作并不是原子性的。在三步中的任意一步，i的值都有可能被其他线程更改。</p>
<h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><p>可见性是指当有多个线程访问同一个变量时，一个线程对这个变量做了修改，其他线程能立即看到修改的值。这里可能比<br>较难理解。举个例子来说明这种情况。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//线程1执行的代码</span></div><div class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="comment">//线程2执行的代码</span></div><div class="line">j = i;</div></pre></td></tr></table></figure></p>
<p>CPU在执行语句加载东西时，并不是直接从内存中去读取数据，而是首先将数据加载到cpu的高速缓存中，当数据处理完毕<br>后再传到内存当中。<br>假设执行第一句的线程是CPU1，而执行第二句的是CPU2。当线程1执行 i =10这句时，会先把i的初始值加载到CPU1的高<br>速缓存中，然后赋值为10，那么在CPU1的高速缓存当中i的值变为10了，却没有立即写入到主内存当中。<br>此时线程2执行 j = i，它会先去内存读取i的值并加载到CPU2的缓存当中，注意此时内存当中i的值还是0，那么就会使<br>得j的值为0，而不是10.<br>这就是可见性问题，线程1对变量i修改了之后，线程2没有立即看到线程1修改的值。</p>
<h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><p>Java 语言提供了 volatile 和 synchronized 两个关键字来保证线程之间操作的有序性，volatile对一个变量的写<br>操作先行发生于后面对这个变量的读操作，synchronized 是由“一个变量在同一个时刻只允许一条线程对其进行 lock<br>操作”这条规则获得的，此规则决定了持有同一个对象锁的两个同步块只能串行执行。</p>
<h2 id="volatile关键字深入探索"><a href="#volatile关键字深入探索" class="headerlink" title="volatile关键字深入探索"></a>volatile关键字深入探索</h2><h3 id="volatile关键字能能保证原子性吗"><a href="#volatile关键字能能保证原子性吗" class="headerlink" title="volatile关键字能能保证原子性吗"></a>volatile关键字能能保证原子性吗</h3><p>demo：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>&#123;</div><div class="line">        i ++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">        VolatileDemo demo = <span class="keyword">new</span> VolatileDemo();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">10</span>; j ++)&#123;</div><div class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> a = <span class="number">0</span>;a &lt; <span class="number">1000</span>;a ++)&#123;</div><div class="line">                    demo.add();</div><div class="line">                &#125;</div><div class="line">            &#125;).start();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (Thread.activeCount()&gt;<span class="number">1</span>)&#123;</div><div class="line">            Thread.yield();</div><div class="line">        &#125;</div><div class="line">        System.out.println(demo.i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上代码的输出结果是一个小于等于10000的数字。因此volatile关键字不具备原子性。对其修饰的变量进行修改，不能保证<br>线程安全。要保证以上代码的线程安全，需要保证add()方法操作的原子性，可以通过使用Lock锁，或者使用synchronized。<br>也可以使用jdk中提供的AtomicInteger。这个类保证了在并发情况下，对数字的自增操作的原子性。</p>
<blockquote>
<p>总结，volatile关键字可以保证被其修饰的变量的有序性和可见性，但无法保证其操作的原子性。  </p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;volatile是java中的关键字，在涉及到并发编程时会用到，特地对其特点进行学习与总结，以更好的理解其&lt;br&gt;应用场景以及其中的原理。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;相关概念&quot;&gt;&lt;a href=&quot;#相关概念&quot; class=
    
    </summary>
    
      <category term="java基础" scheme="http://jollyfly.com/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="java基础" scheme="http://jollyfly.com/tags/java%E5%9F%BA%E7%A1%80/"/>
    
      <category term="并发" scheme="http://jollyfly.com/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>linux下安装rabbitMQ</title>
    <link href="http://jollyfly.com/2017/07/08/rabbitmq-install/"/>
    <id>http://jollyfly.com/2017/07/08/rabbitmq-install/</id>
    <published>2017-07-08T03:50:48.000Z</published>
    <updated>2017-07-12T00:15:56.034Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>此篇博客主要记录rabbitMQ在linux系统上的安装过程，使用与CentOS、Redhat。</p>
</blockquote>
<h2 id="安装Erlang"><a href="#安装Erlang" class="headerlink" title="安装Erlang"></a>安装Erlang</h2><p>RabbitMQ由Erlang实现，所以安装Erlang必不可少</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</div><div class="line">mkdir rabbitmq</div><div class="line"><span class="built_in">cd</span> rabbitmq</div><div class="line">wget http://packages.erlang-solutions.com/erlang-solutions-1.0-1.noarch.rpm</div><div class="line">rpm -Uvh erlang-solutions-1.0-1.noarch.rpm</div><div class="line">rpm --import http://packages.erlang-solutions.com/rpm/erlang_solutions.asc</div><div class="line">sudo yum install erlang</div></pre></td></tr></table></figure>
<blockquote>
<p><img src="/img/erlang.png" alt="安装Erlang"></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#上传rpm安装包到/usr/local/src/rabbitmq/   可使用rz命令上传</span></div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/rabbitmq</div><div class="line">rz -y</div><div class="line"><span class="comment">#上传完成后安装</span></div><div class="line">rpm -ivh rabbitmq-server-3.4.1-1.noarch.rpm</div></pre></td></tr></table></figure>
<h3 id="服务的启动与停止"><a href="#服务的启动与停止" class="headerlink" title="服务的启动与停止"></a>服务的启动与停止</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">service rabbitmq-server start</div><div class="line">service rabbitmq-server stop</div><div class="line">service rabbitmq-server restart</div></pre></td></tr></table></figure>
<h3 id="设置开机启动"><a href="#设置开机启动" class="headerlink" title="设置开机启动"></a>设置开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkconfig rabbitmq-server on</div></pre></td></tr></table></figure>
<h3 id="设置配置文件"><a href="#设置配置文件" class="headerlink" title="设置配置文件"></a>设置配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/rabbitmq</div><div class="line">cp /usr/share/doc/rabbitmq-server-3.4.1/rabbitmq.config.example /etc/rabbitmq/</div><div class="line">mv rabbitmq.config.example rabbitmq.config</div></pre></td></tr></table></figure>
<h3 id="开启用户远程访问"><a href="#开启用户远程访问" class="headerlink" title="开启用户远程访问"></a>开启用户远程访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/rabbitmq/rabbitmq.config</div></pre></td></tr></table></figure>
<p><img src="/img/rabbitmq1.png" alt="用户远程访问"></p>
<h3 id="开启web界面管理工具"><a href="#开启web界面管理工具" class="headerlink" title="开启web界面管理工具"></a>开启web界面管理工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</div><div class="line">service rabbitmq-server restart</div></pre></td></tr></table></figure>
<h3 id="防火墙开放15672端口"><a href="#防火墙开放15672端口" class="headerlink" title="防火墙开放15672端口"></a>防火墙开放15672端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/sbin/iptables -I INPUT -p tcp --dport 15672 -j ACCEPT</div><div class="line">/etc/rc.d/init.d/iptables save</div></pre></td></tr></table></figure>
<h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><blockquote>
<p>安装并配置完成后，需要登录web界面管理工具添加用户</p>
</blockquote>
<p><img src="/img/rabbitmq2.png" alt="web界面"></p>
<h3 id="用户角色"><a href="#用户角色" class="headerlink" title="用户角色"></a>用户角色</h3><ol>
<li>超级管理员（adminisitrator）<br>可登陆管理控制台，可查看所有的信息，并且可以对用户，策略(policy)进行操作。</li>
<li>监控者(monitoring)<br>可登陆管理控制台，同时可以查看rabbitmq节点的相关信息(进程数，内存使用情况，磁盘使用情况等)</li>
<li>策略制定者(policymaker)<br>可登陆管理控制台, 同时可以对polic进行管理。但无法查看节点的相关信息(上图红框标识的部分)。</li>
<li>普通管理者(management)<br>仅可登陆管理控制台，无法看到节点信息，也无法对策略进行管理。</li>
<li>其他<br>无法登陆管理控制台，通常就是普通的生产者和消费者。</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;此篇博客主要记录rabbitMQ在linux系统上的安装过程，使用与CentOS、Redhat。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;安装Erlang&quot;&gt;&lt;a href=&quot;#安装Erlang&quot; class=&quot;headerlink&quot; 
    
    </summary>
    
      <category term="软件安装" scheme="http://jollyfly.com/categories/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/"/>
    
    
      <category term="mq" scheme="http://jollyfly.com/tags/mq/"/>
    
  </entry>
  
  <entry>
    <title>NIO学习与总结</title>
    <link href="http://jollyfly.com/2017/07/07/nio/"/>
    <id>http://jollyfly.com/2017/07/07/nio/</id>
    <published>2017-07-07T08:50:48.000Z</published>
    <updated>2017-09-01T02:08:50.812Z</updated>
    
    <content type="html"><![CDATA[<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>nio即non-blocking IO翻译过来就是非阻塞式IO</p>
<h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><p>Channel意思是通道，在NIO中，数据从通道读入到缓冲区，<br>再从缓冲区获取。常见的Channel类型有：FileChannel,DatagramChannel,SocketChannel,<br>ServerSocketChannel。</p>
<h4 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h4><p><img src="/img/Buffer.jpg" alt="Buffer"></p>
<p>NIO里面关键的Buffer实现：ByteBuffer，CharBuffer，DoubleBuffer，FloatBuffer，IntBuffer，LongBuffer，ShortBuffer<br>这些Buffer覆盖了你能通过IO发送的基本数据类型：byte，short，int，long，float，<br>double和char。<br><br>Buffer的初始状态为read状态，如果需要写入数据  需要先调用flip()方法<br></p>
<ul>
<li>capacity:<br><br>作为一个内存块，Buffer有一个固定的大小值，也叫“capacity”.你只能往里写capacity个<br>byte、long，char等类型。一旦Buffer满了，需要将其清空（通过读数据或者清除数据）<br>才能继续写数据往里写数据。</li>
<li>position<br><br>当你写数据到Buffer中时，position表示当前的位置。初始的position值为0.当一个byte、<br>long等数据写到Buffer后， position会向前移动到下一个可插入数据的Buffer单元。<br>position最大可为capacity – 1.当读取数据时，也是从某个特定位置读。当将Buffer<br>从写模式切换到读模式，position会被重置为0. 当从Buffer的position处读取数据时，<br>position向前移动到下一个可读的位置。</li>
<li>limit<br><br>在写模式下，Buffer的limit表示你最多能往Buffer里写多少数据。 写模式下，limit等于<br>Buffer的capacity。当切换Buffer到读模式时， limit表示你最多能读到多少数据。因此，<br>当切换Buffer到读模式时，limit会被设置成写模式下的position值。换句话说，你能读到<br>之前写入的所有数据（limit被设置成已写数据的数量，这个值在写模式下就是position）</li>
<li>scatter/gather<br><br>分散（scatter）从Channel中读取是指在读操作时将读取的数据写入多个buffer中。因此，<br>Channel将从Channel中读取的数据“分散（scatter）”到多个Buffer中。<br><br>聚集（gather）写入Channel是指在写操作时将多个buffer的数据写入同一个Channel，<br>因此，Channel将多个Buffer中的数据“聚集（gather）”后发送到Channel。<h4 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h4>使用Selector可以用一个线程来管理多个通道。<br><br>Selector的创建:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//使用open()方法创建一个Selector对象</div><div class="line">Selector selector = Selector.open();</div><div class="line">//与Selector一起使用时，Channel必须处于非阻塞模式下。这意味着不能将FileChannel&lt;br&gt;</div><div class="line">//与Selector一起使用，因为FileChannel不能切换到非阻塞模式。而套接字通道都可以。</div><div class="line">serverSocketChannel.configureBlocking(false);</div><div class="line">SelectionKey key = serverSocketChannel.register(selector,Selectionkey.OP_READ);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>以上代码中，register()方法的第二个参数，<br>意思是在通过Selector监听Channel时对什么事件感兴趣。可以监听四中不同类型的事件：</p>
<ol>
<li>Connect</li>
<li>Accept</li>
<li>Read</li>
<li>Write<br>通道触发了一个事件意思是该事件已经就绪。<br>所以，某个channel成功连接到另一个服务器称为”连接就绪”。一个server socket channel准备好接<br>收新进入的连接称为”接收就绪”。一个有数据可读的通道可以说是”读就绪”。等待写数据的通道可以说是<br>“写就绪”。这四种事件用SelectionKey的四个常量来表示：</li>
<li>SelectionKey.OP_CONNECT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   连接就绪</li>
<li>SelectionKey.OP_ACCEPT     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   接收就绪</li>
<li>SelectionKey.OP_READ    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     读就绪</li>
<li><p>SelectionKey.OP_WRITE    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     写就绪<br>如果你对不止一种事件感兴趣，那么可以用<br>“位或”操作符将常量连接起来，如下：<br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int interestSet = SelectionKey.OP_READ | SelectionKey.OP_WRITE;</div></pre></td></tr></table></figure>
<p>selector中select()方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int select(); //会阻塞</div><div class="line">int select(long timeout); //阻塞timeout毫秒</div><div class="line">int selectNow();//不会阻塞，立即返回</div></pre></td></tr></table></figure>
<p>select()方法返回的int值表示有多少通道已经就绪。<br>亦即，自上次调用select()方法后有多少通道变成就绪状态。<br>如果调用select()方法，因为有一个通道变成就绪状态，返回了1，若再次调用select()方法，如果另一个通道就<br>绪了，它会再次返回1.如果对第一个就绪的channel没有做任何操作，现在就有两个就绪的通道，但是在每次select()<br>方法调用之间，只有一个通道就绪了。调用过select()方法之后。如果返回值表明有一个或更多通道就绪了，就可以<br>通过调用selector的selectKeys()方法，访问”已选择健集”中的就绪通道，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"> Set selectedKeys = selector.selectedKeys();</div><div class="line"> //可以遍历这个已选择的键集合来访问就绪的通道。</div><div class="line"> Set selectKeys = selector.selectedKeys();</div><div class="line"> Iterator keyIterator = selectedKey.iterator();</div><div class="line"> while(keyIterator.hasNext())&#123;</div><div class="line">     SelectionKey key = keyIterator.next();</div><div class="line">     if(key.isAcceptable)&#123;</div><div class="line">         // 接收就绪</div><div class="line">     &#125; </div><div class="line">     if(key.isConnectable())&#123;</div><div class="line">         // 连接就绪</div><div class="line">     &#125;</div><div class="line">     if(key.isReadable())&#123;</div><div class="line">         // 读就绪</div><div class="line">     &#125;</div><div class="line">     if(key.isWritable())&#123;</div><div class="line">         // 写就绪</div><div class="line">     &#125;</div><div class="line">     keyIterator.remove();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意每次迭代末尾的keyIterator.remove()调用。<br>Selector不会自己从已选择键集中移除SelectionKey实例。<br>必须在处理完通道时自己移除。<br>下次该通道变成就绪时，Selector会再次将其放入已选择健集中。<br>SelectionKey.channel()方法返回的通道需要转型成你要处理的类型，如ServerSocketChannel或SocketChannel等。<br><br>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wakeUp():<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;某个线程调用select()方法后阻塞了，即使没有通道已经就绪，<br>也有办法让其从select()方法返回。<br>只要让其它线程在第一个线程调用的select()方法的那个对象上调用selector.wakeup()方法即可。<br>阻塞在select()方法上的线程会立马返回。<br>如果有其它线程调用了wakeup()方法，但当前没有线程阻塞在select()方法上，下个调用select()方法的线程会立即”醒来(wake up)”。<br>&lt;br<br>用完Selector之后调用其close()方法会关闭该Selector，且使注册到该Selector上的所有SelectionKey实例无效。通道本身并不会关闭。</p>
<h4 id="SelectionKey"><a href="#SelectionKey" class="headerlink" title="SelectionKey"></a>SelectionKey<br></h4><p>当向Selector注册Channel时，register()<br>方法会返回一个SelectionKey对象。这个对象包含了一下内容：</p>
</li>
<li><p>interest集合<br><br>interest集合是你所选择的感兴趣的事件集合。可以通过SelectionKey读写interest集合，像这样：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">int interestSet = selectionKey.interestOps();</div><div class="line">boolean isInterestedAccept = (interestSet &amp; SelectionKey.OP_ACCEPT) == SelectionKey.OP_ACCEPT;</div><div class="line">boolean isInterestedInConnect = (interestSet &amp; SelectionKey.OP_CONNECT) == SelectionKey.OP_CONNECT;</div><div class="line">boolean isInterestedInRead = (insterestSet &amp; SelectionKey.OP_READ) == SelectionKey.OP_READ;</div><div class="line">boolean isInterestedInWrite = (insterestSet &amp; SelectionKey.OP_WRITE) == SelectionKey.OP_WRITE;</div></pre></td></tr></table></figure>
<p>   通过”位与”操作interest集合和给定的SelectionKey常量，可以确定某个事件是否在interest集合中。</p>
</li>
<li><p>ready集合<br><br>ready集合是通道已经准备就绪的操作的集合。<br>你可以这样访问ready集合:<br></p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int readySet = selectionKey.readyOps();</div></pre></td></tr></table></figure>
<p>   可以用像检测interest集合那样的方法，<br>   来检测Channel中什么事件或操作已经就绪。但是，也可以使用一下四个方法，它们都会返回一个布尔类型：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">selectionKey.isAcceptable();</div><div class="line">selectionKey.isConnectable();</div><div class="line">selectionKey.isReadable();</div><div class="line">sekectionKey.isWritable();</div></pre></td></tr></table></figure>
</li>
<li><p>Channel和Selector：<br>可通过一下方式获取Channel和Selector对象</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Channel channel = selectionKey.channel();</div><div class="line">Selector selector = selectionKey.selector();</div></pre></td></tr></table></figure>
</li>
<li><p>附加对象<br>可以将一个对像或者更多信息附着到<br>SelectionKey上，这样就能方便的识别某个给定的通道。附加方法如下：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">selectionKey.attach(theObject);</div><div class="line">Object attachedObj = selectionKey.attachment();</div></pre></td></tr></table></figure></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h4&gt;&lt;p&gt;nio即non-blocking IO翻译过来就是非阻塞式IO&lt;/p&gt;
&lt;h4 id=&quot;Channel&quot;&gt;&lt;a href=&quot;#Channel
    
    </summary>
    
      <category term="学习笔记" scheme="http://jollyfly.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="java基础" scheme="http://jollyfly.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="nio" scheme="http://jollyfly.com/tags/nio/"/>
    
  </entry>
  
  <entry>
    <title>redis学习与总结</title>
    <link href="http://jollyfly.com/2017/07/07/redis/"/>
    <id>http://jollyfly.com/2017/07/07/redis/</id>
    <published>2017-07-07T08:50:48.000Z</published>
    <updated>2017-07-10T05:46:32.512Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Redis的基本数据类型"><a href="#Redis的基本数据类型" class="headerlink" title="Redis的基本数据类型"></a>Redis的基本数据类型</h3><blockquote>
<p>redis中目前支持五种数据类型：</p>
<ol>
<li>String </li>
<li>List </li>
<li>Hash </li>
<li>Set</li>
<li>Sorted Set<h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><h5 id="结构说明"><a href="#结构说明" class="headerlink" title="结构说明"></a>结构说明</h5>String是简单的key-value键值对。<h5 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h5>赋值与取值：<br><br>SET key value<br>GET key<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:6379&gt; set content hello</div><div class="line">OK</div><div class="line">redis 127.0.0.1:6379&gt; get content</div><div class="line">&quot;hello&quot;</div></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<h5 id="Jedis中操作String"><a href="#Jedis中操作String" class="headerlink" title="Jedis中操作String"></a>Jedis中操作String</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDemo</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span></span>&#123;</div><div class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"127.0.0.1"</span>,<span class="number">6379</span>);</div><div class="line">        String content = jedis.get(<span class="string">"content"</span>);</div><div class="line">        System.out.println(content);</div><div class="line">        jedis.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><h5 id="结构说明-1"><a href="#结构说明-1" class="headerlink" title="结构说明"></a>结构说明</h5><blockquote>
<p>redis中的List实现为一个双向链表，类似于java中的LinkedList。支持反向查找和遍历。</p>
<h5 id="基本命令-1"><a href="#基本命令-1" class="headerlink" title="基本命令"></a>基本命令</h5><ul>
<li>BLPOP<br>BLPOP key1 [key2] timeout 取出并获取列表中的第一个元素，或阻塞，直到有可用</li>
<li>BRPOP<br>BRPOP key1 [key2] timeout 取出并获取列表中的最后一个元素，或阻塞，直到有可用</li>
<li>LINDEX<br>LINDEX key index 根据一个列表的索引，获取对应位置的元素</li>
<li>LINSERT<br>LINSERT key BEFORE|AFTER pivot value 在列表中的指定元素之后或之前插入一个元素，若<br>  有重复元素仅对第一个生效。</li>
<li>LLEN<br>LLEN key 获取列表的长度</li>
<li>LRANGE<br>LRANGE key start stop 从一个列表中获取各种元素</li>
<li>LREM<br>LREM key count value 从列表中删除第count个指定value。如果count是0，所有的值为value<br>  的元素都会被删除。如果count是一个负数，则从列表的尾部到头部删除。</li>
<li>LSET<br>LSET key index value 将列表中指定索引的值更新为value。<h5 id="基本命令使用"><a href="#基本命令使用" class="headerlink" title="基本命令使用"></a>基本命令使用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:6379&gt; lpush list1 redis</div><div class="line">(integer) 1</div><div class="line">redis 127.0.0.1:6379&gt; lpush list1 hello</div><div class="line">(integer) 2</div><div class="line">redis 127.0.0.1:6379&gt; rpush list1 world</div><div class="line">(integer) 3</div><div class="line">redis 127.0.0.1:6379&gt; llen list1</div><div class="line">(integer) 3</div><div class="line">redis 127.0.0.1:6379&gt; lrange list1 0 3</div><div class="line">1) &quot;hello&quot;</div><div class="line">2) &quot;redis&quot;</div><div class="line">3) &quot;world&quot;</div><div class="line">redis 127.0.0.1:6379&gt; lpop list1</div><div class="line">&quot;hello&quot;</div><div class="line">redis 127.0.0.1:6379&gt; rpop list1</div><div class="line">&quot;world&quot;</div><div class="line">redis 127.0.0.1:6379&gt; lrange list1 0 3</div><div class="line">1) &quot;redis&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<h5 id="jedis中操作List"><a href="#jedis中操作List" class="headerlink" title="jedis中操作List"></a>jedis中操作List</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">String books[] = &#123;&quot;aaa&quot;,&quot;bbb&quot;,&quot;ccc&quot;,&quot;ddd&quot;,&quot;eee&quot;&#125;;</div><div class="line">jedis.lpush(&quot;books&quot;,books);</div><div class="line">System.out.println(jedis.llen(&quot;books&quot;));</div><div class="line">jedis.lrange(&quot;books&quot;,0,100).forEach(e-&gt;&#123;</div><div class="line">    System.out.println(e);</div><div class="line">&#125;);</div><div class="line">System.out.println(&quot;LINDEX:&quot;+jedis.lindex(&quot;books&quot;,3));</div><div class="line">jedis.linsert(&quot;books&quot;, BinaryClient.LIST_POSITION.AFTER,&quot;aaa&quot;,&quot;xxx&quot;);</div><div class="line">System.out.println(&quot;-----------&quot;);</div><div class="line">jedis.lrange(&quot;books&quot;,0,100).forEach(e-&gt;&#123;</div><div class="line">    System.out.println(e);</div><div class="line">&#125;);</div><div class="line">System.out.println(&quot;-----------&quot;);</div><div class="line"></div><div class="line">jedis.lrem(&quot;books&quot;,0,&quot;ccc&quot;);</div><div class="line"></div><div class="line">jedis.lset(&quot;books&quot;,0,&quot;yy&quot;);</div><div class="line">jedis.lrange(&quot;books&quot;,0,100).forEach(e-&gt;&#123;</div><div class="line">    System.out.println(e);</div><div class="line">&#125;);</div><div class="line">jedis.close();</div></pre></td></tr></table></figure>
<h4 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h4><h5 id="结构说明-2"><a href="#结构说明-2" class="headerlink" title="结构说明"></a>结构说明</h5><blockquote>
<p>散列类型存储了字段和字段值的映射，但字段值只能是字符串，不支持其他类型，也就是说，散列类型不能<br>嵌套其他的数据类型。</p>
<h5 id="基本命令使用-1"><a href="#基本命令使用-1" class="headerlink" title="基本命令使用"></a>基本命令使用</h5><ul>
<li>HSET<br>HSET key field value 设置对象指定字段的值</li>
<li>HGET<br>HGET key field 获取对象中该field属性域的值</li>
<li>HMSET<br>HMSET key field value [field value …] 同时设置对象中一个或多个字段的值</li>
<li>HMGET<br>HMGET key field[field…] 获取对象的一个或多个指定字段的值</li>
<li>HGETALL<br>HGETALL key 获取对象的所有属性域和值</li>
<li>HDEL<br>HDEL key field[field…] 删除对象的一个或几个属性域，不存在的属性将被忽略<h5 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; hset person name jack</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hset person age 20</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hset person sex famale</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hgetall person</div><div class="line">1) &quot;name&quot;</div><div class="line">2) &quot;jack&quot;</div><div class="line">3) &quot;age&quot;</div><div class="line">4) &quot;20&quot;</div><div class="line">5) &quot;sex&quot;</div><div class="line">6) &quot;famale&quot;</div><div class="line">127.0.0.1:6379&gt; hkeys person</div><div class="line">1) &quot;name&quot;</div><div class="line">2) &quot;age&quot;</div><div class="line">3) &quot;sex&quot;</div><div class="line">127.0.0.1:6379&gt; hvals person</div><div class="line">1) &quot;jack&quot;</div><div class="line">2) &quot;20&quot;</div><div class="line">3) &quot;famale&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<h5 id="Jedis中操作Hash结构"><a href="#Jedis中操作Hash结构" class="headerlink" title="Jedis中操作Hash结构"></a>Jedis中操作Hash结构</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Map&lt;String,String&gt; dataMap = new HashMap&lt;String,String&gt;();</div><div class="line">dataMap.put(&quot;id&quot;,&quot;1001&quot;);</div><div class="line">dataMap.put(&quot;name&quot;,&quot;Lisa&quot;);</div><div class="line">dataMap.put(&quot;age&quot;,&quot;23&quot;);</div><div class="line">jedis.hmset(&quot;user_1001&quot;,dataMap);</div><div class="line">System.out.println(jedis.hget(&quot;user_1001&quot;,&quot;age&quot;));</div><div class="line">dataMap = jedis.hgetAll(&quot;user_1001&quot;);</div><div class="line">System.out.println(dataMap);</div></pre></td></tr></table></figure>
<h3 id="Redis配置文件"><a href="#Redis配置文件" class="headerlink" title="Redis配置文件"></a>Redis配置文件</h3><blockquote>
<p>redis默认配置文件为redis.conf,常用配置如下：</p>
<ol>
<li>port  服务端口号</li>
<li>bind  绑定ip，其他的ip不能访问（多个ip用空格隔开）</li>
<li>databases 数据库数量，默认为16个</li>
<li>daemonize 设置为守护进程</li>
<li>maxmemory 最大内存大小</li>
</ol>
</blockquote>
<h3 id="Redis的持久化"><a href="#Redis的持久化" class="headerlink" title="Redis的持久化"></a>Redis的持久化</h3><blockquote>
<p>Redis支持两种方式的持久化，一种是RDB，一种是AOF。可以单独使用其中一种或者两种结合使用。</p>
<h4 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h4><p>RDB是用过快照完成的，当符合一定条件时，Redis会自动将内存中的所有数据进行快照并且存储到硬盘上。<br>进行快照的条件在配置文件中指定。RDB是Redis默认的持久化方式。<br><br>在配置文件中预置了3个RDB持久化的条件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">save 900 1 #15分钟内有至少一个键被更改则进行快照</div><div class="line">save 300 10 #5分钟内至少有10个键被更改则进行快照</div><div class="line">save 60 100000 #1分钟内至少有10000个键被更改则进行快照</div></pre></td></tr></table></figure></p>
<p>以上条件之间是或的关系。默认的rdb文件路径是在当前目录，文件名是：dump.rdb，可以在配置文件<br>中修改路径和文件名，分别是dir和dbfilename。注释掉所有的RDB触发条件即可关闭RDB持久化。</p>
<h4 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h4><p>Redis的AOF持久化的原理是将发送到Redis服务端的每一条命令都记录下来，并且保存到硬盘中的AOF文件。<br>AOF文件的位置和RDB文件的位置相同，都是通过dir参数设置。默认的文件名是appendonly.aof，可以通过<br>appendfilename参数修改。AOF持久化默认是不开启的，在配置文件中开启：<br><code>appendonly  yes</code><br></p>
<h3 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h3><p>在Redis3.0及以上版本一大特性就是集群。</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Redis的基本数据类型&quot;&gt;&lt;a href=&quot;#Redis的基本数据类型&quot; class=&quot;headerlink&quot; title=&quot;Redis的基本数据类型&quot;&gt;&lt;/a&gt;Redis的基本数据类型&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;redis中目前支持五种数据类型：
    
    </summary>
    
      <category term="学习笔记" scheme="http://jollyfly.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="http://jollyfly.com/tags/redis/"/>
    
      <category term="nosql" scheme="http://jollyfly.com/tags/nosql/"/>
    
  </entry>
  
  <entry>
    <title>mysql学习与总结</title>
    <link href="http://jollyfly.com/2017/07/07/mysql/"/>
    <id>http://jollyfly.com/2017/07/07/mysql/</id>
    <published>2017-07-07T07:23:48.000Z</published>
    <updated>2017-08-11T01:57:48.852Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-数据库范式"><a href="#1-数据库范式" class="headerlink" title="1.数据库范式"></a>1.数据库范式</h3><ol>
<li>第一范式（1NF）：<br>第一范式强调的是列的原子性，即列不能够再分成其他几列。</li>
<li>第二范式（2NF）：<br>首先要满足第一范式的要求，另外包含两部分内容，一是表必须有主键；<br>二是没有包含在主键中的列必须完全依赖于主键，而不能只依赖于主键的一部分。<br>例如一个订单明细表（OrderId，ProductId，Quantity，UnitPrice）<br><br>在这张表中，单单通过一个OrderId是不足以成为主键的，主键应该是（OrderId,ProductId）<br>可以将表拆分为（OrderId,ProductId,Quantity）和（ProductId,UnitPrice）</li>
<li>第三范式（3NF）：<br>首先是要满足2NF，另外非主键列必须直接依赖于主键，不能存在传递依赖。即不能存在：非主键列 A 依赖于非主键列 B，非主键列B依赖于主键的情况。<br><br>例如一个订单表【Order】（OrderID，OrderDate，CustomerID，CustomerName，CustomerAddr，CustomerCity）主键是（OrderID）。<br>其中 OrderDate，CustomerID，CustomerName，CustomerAddr，CustomerCity 等非主键列都完全依赖于主键（OrderID），所以符合 2NF。不过问题是 CustomerName，CustomerAddr，CustomerCity 直接依赖的是 CustomerID（非主键列），而不是直接依赖于主键，它是通过传递才依赖于主键，所以不符合 3NF。<br>通过拆分【Order】为【Order】（OrderID，OrderDate，CustomerID）和【Customer】（CustomerID，CustomerName，CustomerAddr，CustomerCity）从而达到 3NF。</li>
</ol>
<h3 id="2-索引基础"><a href="#2-索引基础" class="headerlink" title="2.索引基础"></a>2.索引基础</h3><h4 id="B-Tree索引"><a href="#B-Tree索引" class="headerlink" title="B-Tree索引"></a>B-Tree索引</h4><p>B-Tree索引能够加快访问数据的速度，因为存储引擎不再需要进行全表扫描来获取需要的数据，<br>取而代之的是从索引的根节点(图示并未画出)开始进行搜索。根节点的槽中存放了指向子节点的指针，<br>存储引擎根据这些指针向下层查找。通过比较节点页的值和要查找的值可以找到合适的指针进入下层<br>子节点，这些指针实际上定义了子节点页中值的上限和下限。最终存储引擎要么是找到对应的值，要么<br>该记录不存在。<br><br>索引对多个值进行排序的依据是CREATE TABLE语句中定义索引时列的顺序。<br>例：假设有如下数据表：<br>CREATE TABLE People(<br>    last_name  varchar(50)   not null,<br>    first_name varchar(50)   not null,<br>    dob        date             not null,<br>    gender       enum(‘m’,’f’) not null,<br>    key(last_name, first_name, dob)<br>);</p>
<p>对于表中的每一行数据，索引中包含了last_name,first_name和dob列的值。<br>可以使用B-Tree索引的查询类型。B-Tree索引适用于全键值、键值范围或键前缀查找。其中键前缀查找<br>只适用于根据最左前缀的查找。上面所述的索引对如下类型的查询有效。</p>
<ol>
<li>全值匹配<br><br>全值匹配指的是和索引中的所有列进行匹配，例如前面提到的索引可用于查找姓名为 Cuba Allen、<br>出生于1960-01-01的人。</li>
<li>匹配最左前缀(last_name)<br><br>前面提到的索引可用于查找所有姓为Allen的人，即只使用索引的第一列。</li>
<li>匹配列前缀<br><br>也可以只匹配某一列的值的开头部分。例如前面提到的索引可用于查找所有以J开<br>头的姓的人。<br>这里也只使用了索引的第一列。</li>
<li>匹配范围值<br><br>例如前面提到的索引可用于查找姓在Allen和Barrymore之间的人，这里也只使<br>用了索引的第一列。</li>
<li>精确匹配某一列并范围匹配另外一列<br><br>前面提到的索引也可用于查找所有姓为Allen，并且名字是字母K开头的人。</li>
<li>只访问索引的查询<br><br>B-Tree通常可以支持”只访问索引的查询”，即查询只需要访问索引，<br>而无须访问数据行。</li>
</ol>
<h5 id="B-Tree索引的限制："><a href="#B-Tree索引的限制：" class="headerlink" title="B-Tree索引的限制："></a>B-Tree索引的限制：</h5><ol>
<li>如果不是按照索引的最左列开始查找，则无法使用索引。</li>
<li>不能跳过索引中的列。</li>
<li>如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找。</li>
</ol>
<h5 id="典型优化："><a href="#典型优化：" class="headerlink" title="典型优化："></a>典型优化：</h5><p>使用B-Tree存储URL，因为URL一般比较长，因此数据量大的时候，查询会变得缓<br> 慢。若删除原来URL列上的索引，而新增一个被索引的url_crc列，使用CRC32做<br> 哈希，就可以使用下面的方式查询：</p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> #原查询语句：</div><div class="line">   SELECT id FROM url WHERE url='http://www.mysql.com';</div><div class="line">#修改后的语句：</div><div class="line">   SELECT id FROM url WHERE url='http://www.mysql.com'</div><div class="line">                 AND url_crc=CRC32('http://www.mysql.com');</div></pre></td></tr></table></figure>
<blockquote>
<p>这样做的性能会非常高，因为MySQL优化器会使用这个选择性很高而体积很小的基于url_crc列的索引<br>来完成查找。即使有多个记录有相同的索引值，查找仍然很快，只需要根据哈希值做快速的整数比较就能<br>找到索引条目，然后一一比较返回对应的行。可以使用触发器来维护哈希值，例：</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#创建表</div><div class="line">    CREATE TABLE pseudohash(</div><div class="line">        id int unsigned NOT NULL auto_increment,</div><div class="line">        url varchar(255) NOT NULL,</div><div class="line">        url_crc int unsigned NOT NULL DEFAULT 0,</div><div class="line">        PRIMARY KEY(id);</div><div class="line">    );</div><div class="line">#创建触发器</div><div class="line">    CREATE TRIGGER pseudohash_crc_ins BEFORE INSERT ON pseudohash FOR EACH ROW BEGIN</div><div class="line">    SET NEW.url_crc=CRC32(NEW.url);</div><div class="line">    END;</div><div class="line"></div><div class="line">    CREATE TRIGGER pseudohash_crc_ins BEFORE UPDATE ON pseudohash FOR EACH ROW BEGIN</div><div class="line">    SET NEW.url_crc=CRC32(NEW.url);</div><div class="line">    END;</div></pre></td></tr></table></figure>
<p> #####高性能的索引使用策略</p>
<ol>
<li>独立的列<br>一些不恰当的查询会使MySQL无法使用已有的索引，如果查询中的列不是独立的<br>列，则MySQL就不会使用索引。“独立的列”是指索引列不能是表达式的一部分，<br>也不能是函数的参数。例：<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> sakila.actor</div><div class="line">    <span class="keyword">WHERE</span> actor_id + <span class="number">1</span> = <span class="number">5</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>  凭肉眼就能看出WHERE中的表达式其实等价于actor_id = 4，但是MySQL无法自<br>  动解析这个方程式。另一个常见的错误：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> ... <span class="keyword">WHERE</span> <span class="keyword">TO_DAYS</span>(<span class="keyword">CURRENT_DATE</span>)</div><div class="line">    - <span class="keyword">TO_DAYS</span>(date_col) &lt;= <span class="number">10</span>;</div></pre></td></tr></table></figure>
<ol>
<li><p>前缀索引和索引选择性<br>如果索引列的字符串很长，索引会变得大且慢。通常可以索引开始部分的字符，这样可以大大节约索引<br>空间，从而提高索引效率。但这样也会降低索引的选择性。对于BLOB、TEXT或者很长的VARCHAR类型的列，<br>必须使用前缀索引，因为MySQL不允许索引这些列完整的长度。创建索引的SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> sakila.city_demo <span class="keyword">ADD</span> <span class="keyword">KEY</span> (city(<span class="number">7</span>));</div></pre></td></tr></table></figure>
</li>
<li><p>多列索引<br>很多人对多列索引的理解都不够，一个常见的错误就是，为每个列创建独立的索引，或者按照错误的<br>顺序创建多列索引。</p>
<ul>
<li>当出现服务器对多个索引做相交操作时(通常有多个AND条件)，通常意味着需要一个包含所有相关<br>列的多列索引，而不是多个独立的单列索引。</li>
<li>当服务器需要对多个索引做联合操作时(通常有多个OR条件)，通常需要消耗大量的CPU和内存资源<br>在算法的缓存、排序和合并操作上。特别是当其中有些索引的选择性不高，需要合并扫描返回的大量<br>数据的时候。</li>
</ul>
</li>
<li><p>重复索引：</p>
<ol>
<li>主键列和唯一列，不需要再创建索引，因为MySQL的主键限制和唯一限制都是通过索引来实现的。</li>
<li>如果创建了索引(A,B),再创建索引(A)就是冗余索引。因为索引(A,B)也可以当作索引(A)来使用。</li>
</ol>
</li>
</ol>
<h3 id="3-EXPLAN"><a href="#3-EXPLAN" class="headerlink" title="3.EXPLAN"></a>3.EXPLAN</h3><p>在MySQL中可以使用EXPLAN查看SQL执行计划，用法：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span></div></pre></td></tr></table></figure></p>
<p>####3.1结果说明</p>
<ol>
<li>id<br><br> SELECT识别符。这是SELECT查询序列号。这个不重要。</li>
<li>select_type<br><br> 表示SELECT语句的类型，有以下几种值：<ol>
<li>SIMPLE<br><br>表示简单查询，其中不包含连接查询和子查询。</li>
<li>PRIMARY<br><br>表示主查询，或者是最外面的查询语句。</li>
<li>UNION<br><br>表示连接查询的第2个或后面的查询语句。</li>
<li>DEPENDENT UNION<br><br>UNION中的第二个或后面的SELECT语句，取决于外面的查询。</li>
<li>UNION RESULT<br>连接查询的结果</li>
<li>SUBQUERY<br>子查询中的第1个SELECT语句。</li>
<li>DEPENDENT SUBQUERY<br>子查询中的第1个SELECT语句，取决于外面的查询。</li>
<li>DERIVED<br>SELECT(FROM 子句的子查询)。</li>
</ol>
</li>
<li>type(重要)<ol>
<li>system<br><br>表仅有一行，这是const类型的特列，平时不会出现，这个也可以忽略不计。</li>
<li>const<br><br>数据表最多只有一个匹配行，因为只匹配一行数据，所以很快，常用于PRIMARY KEY或者UNIQUE<br>索引的查询，可理解为const是最优化的。</li>
<li>eq_ref<br><br>mysql手册是这样说的:”对于每个来自于前面的表的行组合，从该表中读取一行。这可能是最好的<br>联接类型，除了const类型。它用在一个索引的所有部分被联接使用并且索引是UNIQUE或PRIMARY KEY”。eq_ref可以用于使用=比较带索引的列。</li>
<li>ref<br><br>查询条件索引既不是UNIQUE也不是PRIMARY KEY的情况。ref可用于=或&lt;或&gt;操作符的带索引的列。</li>
<li>ref_or_null<br><br>该联接类型如同ref，但是添加了MySQL可以专门搜索包含NULL值的行。在解决子查询中经常使用<br>该联接类型的优化。<br><br><strong>上面这五种情况都是很理想的索引使用情况。</strong><br></li>
<li>index_merge<br><br>该联接类型表示使用了索引合并优化方法。在这种情况下，key列包含了使用的索引的清单，<br>key_len包含了使用的索引的最长的关键元素。</li>
<li>unique_subquery<br><br>该类型替换了下面形式的IN子查询的ref: value IN (SELECT primary_key FROM<br>single_table WHERE some_expr)<br><br>unique_subquery是一个索引查找函数,可以完全替换子查询,效率更高。</li>
<li>index_subquery<br><br>该联接类型类似于unique_subquery。可以替换IN子查询,但只适合下列形式的子查询中的非唯一<br>索引: value IN (SELECT key_column FROM single_table WHERE some_expr)</li>
<li>range<br><br>只检索给定范围的行,使用一个索引来选择行。</li>
<li>index<br><br>该联接类型与ALL相同,除了只有索引树被扫描。这通常比ALL快,因为索引文件通常比数据文件小。</li>
<li>ALL<br><br>对于每个来自于先前的表的行组合,进行完整的表扫描。（性能最差）</li>
</ol>
</li>
<li>table<br><br> 输出的行所引用的表。</li>
<li>possible_keys<br><br> 指出MySQL能使用哪个索引在该表中找到行。如果是空的，没有相关的索引，这时要提高性能，可<br> 通过校验WHERE子句，看是否引用某些字段，或者检查字段是不是适合索引。</li>
<li>key<br><br> 显示MySQL实际决定使用的键。如果没有索引被选择，键是NULL。</li>
<li>key_len<br><br> 显示MySQL决定使用的键的长度。如果键是NULL，长度就是NULL。文档提示特别注意这个值可以得<br> 出一个多重主键里MySQL实际使用了哪一部分。</li>
<li>ref<br><br> 显示哪个字段或常数与key一起被使用。</li>
<li>rows<br><br> 这个数表示MySQL要遍历多少数据才能找到，在innodb上是不准确的。</li>
<li>Extra<br><br>该列包含MySQL解决查询的详细信息<ul>
<li>Distinct：MySQL发现第1个匹配行后,停止为当前的行组合搜索更多的行。</li>
<li>Not exists：MySQL能够对查询进行LEFT JOIN优化,发现1个匹配LEFT JOIN标准的行后,不再为前面的的行组合在该表内检查更多的行。</li>
<li>range checked for each record (index map: #)：MySQL没有发现好的可以使用的索引,<br>但发现如果来自前面的表的列值已知,可能部分索引可以<br>使用。</li>
<li>Using filesort：MySQL需要额外的一次传递,以找出如何按排序顺序检索行。</li>
<li>Using index：从只使用索引树中的信息而不需要进一步搜索读取实际的行来检索表中的列信<br>息。</li>
<li>Using temporary：为了解决查询,MySQL需要创建一个临时表来容纳结果。</li>
<li>Using where：WHERE 子句用于限制哪一个行匹配下一个表或发送到客户。</li>
<li>Using sort_union(…), Using union(…), Using intersect(…)：这些<br>函数说明如何为index_merge联接类型合并索引扫描。</li>
<li>Using index for group-by：类似于访问表的Using index方式,Using index for group-by表示MySQL发现了一个索引,可以用来查 询GROUP BY或DISTINCT查询的所有列,而<br>不要额外搜索硬盘访问实际的表。</li>
</ul>
</li>
</ol>
<h3 id="4-查询性能优化"><a href="#4-查询性能优化" class="headerlink" title="4.查询性能优化"></a>4.查询性能优化</h3><p>查询的生命周期：从客户端，到服务器，在服务器上进行解析，生成执行计划，执行，返回结果给客户端。<br>其中”执行“可以认为是最重要的阶段。这其中包括了大量为了检索数据到存储引擎的调用以及调用后的数据<br>处理，包括排序，分组等。<br><br>查询性能低下的最基本原因是访问的数据太多。大部分性能低下的查询都可以通过减少访问的数据量的方式<br>进行优化。对于低效的查询，我们发现通过下面两个步骤来分析总是很有效：</p>
<ol>
<li>确认应用程序是否在检索大量超过需要的数据。这通常意味着访问了太多的行，但有时候也可能是访问了<br>太多的列。</li>
<li>确认MySQL服务器层是否在分析大量超过需要的数据行。</li>
</ol>
<p>简单的衡量查询开销的三个指标如下：</p>
<ol>
<li>响应时间</li>
<li>扫描的行数</li>
<li>返回的行数</li>
</ol>
<p>这三个指标都会记录到MySQL的慢日志中，所以检查慢日志记录是找出扫描行数过多的查询的好办法。</p>
<ol>
<li>响应时间<br><br>响应时间分为服务时间和排队时间。服务时间是指数据库处理这个查询真正花了多长时间。排队时间<br>是指服务器因为等待某些资源而没有真正执行查询的时间——可能是等I/O操作完成，也可能是等待行锁，<br>等待。</li>
<li>扫描的行数和返回的行数<br><br>分析查询时，查看该查询扫描的行数是非常有帮助的，这在一定程度上能够说明该查询找到需要的数据<br>的效率高不高。理想情况下扫描的行数和返回的行数应该是相同的。但实际情况这种事并不多。</li>
<li>扫描的行数和访问类型<br><br>在EXPLAIN语句中的type列反应了访问类型，访问类型有很多种，从全表扫描到索引扫描、范围扫描、<br>唯一索查询、常数引用等。这里列的这些，速度是从慢到快。扫描的行数也是从小到大。需要明白扫描<br>表，扫描索引，范围访问和单值访问的概念。</li>
</ol>
<p>一般MySQL能够使用如下三种方式应用WHERE条件，从好到坏依次为：</p>
<ol>
<li>在索引中使用WHERE条件来过滤不匹配的记录，这是在存储引擎层完成的。</li>
<li>使用索引覆盖扫描(在Extra列中出现了Using index)来返回记录，直接从索引中过滤不需要的记<br>录并返回命中的结果。这是在Mysql服务器层完成的，但无须再回表查询记录。</li>
<li>从数据表中返回数据，然后过滤不满足条件的记录(在Extra列中出现Using Where)。这在MySQL<br>服务器层完成，MySQL需要先从数据表读出记录，然后过滤。</li>
</ol>
<p>如果发现查询需要扫描大量的数据，但只返回少数的行，那么可以尝试下面的方法去优化：</p>
<ol>
<li>使用索引覆盖扫描，把所有需要用的列都放到索引中，这样存储引擎无须回表获取对应行就可以返<br>回结果了。</li>
<li>改变库表结构，例如使用单独的汇总表。</li>
<li>重写这个复杂的查询，让MySQL优化器能够以更优化的方式执行这个查询。</li>
</ol>
<p>在优化有问题的查询时，目标应该是找到一个更优的方法获得实际需要的结果————而不一定总是需要从<br>MySQL获取一模一样的结果集。有时候，可以将查询转换一种写法让其返回一样的结果，但是性能更好。<br>但也可以通过修改应用代码，用另一种方式完成查询，最终达到一样的目的。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-数据库范式&quot;&gt;&lt;a href=&quot;#1-数据库范式&quot; class=&quot;headerlink&quot; title=&quot;1.数据库范式&quot;&gt;&lt;/a&gt;1.数据库范式&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;第一范式（1NF）：&lt;br&gt;第一范式强调的是列的原子性，即列不能够再分成其他几列。&lt;/l
    
    </summary>
    
      <category term="学习笔记" scheme="http://jollyfly.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="mysql" scheme="http://jollyfly.com/tags/mysql/"/>
    
      <category term="数据库" scheme="http://jollyfly.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>关于。。</title>
    <link href="http://jollyfly.com/2017/07/07/first/"/>
    <id>http://jollyfly.com/2017/07/07/first/</id>
    <published>2017-07-07T06:23:48.000Z</published>
    <updated>2017-09-11T01:53:51.741Z</updated>
    
    <content type="html"><![CDATA[<h1 id="搭建博客的心路历程"><a href="#搭建博客的心路历程" class="headerlink" title="搭建博客的心路历程"></a>搭建博客的心路历程</h1><p>一直想搭建一个属于自己的博客。最开始的想法是自己写一套出来，然后弄个云服务器部署起来，自己一个人想怎么嗨就怎么嗨。但实际情况是，周期太长。后来还是决定用hexo搭建一个博客出来，这下好了，云服务器的钱也省了。哈哈。<br>然后抽了一天时间，给弄了出来，捣鼓主题、评论什么的，整个过程还是很有意思的。</p>
<h1 id="为什么想要自己搭个人博客"><a href="#为什么想要自己搭个人博客" class="headerlink" title="为什么想要自己搭个人博客"></a>为什么想要自己搭个人博客</h1><p>博客主要是记录下自己的学习过程以及一些总结，偶尔还可以写写别的东西。个人是比较喜欢旅游的，有空也可以记录记录自己走过的地方，是一种不错的回忆。自己想想可能有以下几个原因驱动我吧：</p>
<ol>
<li><strong>简洁、自由</strong>。因此在看到themes主题时，就爱上了这个主题</li>
<li><strong>可玩性强</strong>。由于hexo主题特别多，心情好时换换主题，也是种不错的体验</li>
<li><strong>炫酷</strong>。我可以设置自己的专属顶级域名，哈哈</li>
</ol>
<h1 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h1>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;搭建博客的心路历程&quot;&gt;&lt;a href=&quot;#搭建博客的心路历程&quot; class=&quot;headerlink&quot; title=&quot;搭建博客的心路历程&quot;&gt;&lt;/a&gt;搭建博客的心路历程&lt;/h1&gt;&lt;p&gt;一直想搭建一个属于自己的博客。最开始的想法是自己写一套出来，然后弄个云服务器部署起来
    
    </summary>
    
      <category term="日记" scheme="http://jollyfly.com/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
      <category term="随笔" scheme="http://jollyfly.com/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
</feed>
